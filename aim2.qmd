---
title: "aim2"
author: "Hannah Olson-Williams, Amy Cochran"
format: 
  docx:
    message: false
    warning: false
    echo: false
editor: visual
bibliography: references.bib
---

```{r set up }
library(tidyverse)
library(ggplot2)
library(table1)
load("data_processed/migterm_imp.Rdata")
```

## Abstract

Although the relationship between place and health is well studied and measured, typical place-based measures of health are static, representing a single point in time without accounting for movement or mobility. Among the well-established understanding that place influences health is the understanding that place differentially impacts some groups of people more than others. What remains unknown is to what extent population migration explains place-based health and health disparities. Thus, there is a critical need to measure the degree to which county-level patterns in health factors and outcomes can be attributed to county-level patterns in mobility. Without such knowledge, we are unable to fully capture the complexities of county-level health, limiting our ability to inform local policy making.

This paper aims to provide understanding of the mechanisms by which mobility may be related to place-based health disparities so that local decision-makers may account for patterns in mobility when creating policy towards improved health for all people in all places. In this paper, we quantify and devise techniques for quantifying the relationship between county-level mobility and county-level health. Understanding rural-urban mobility patterns is a necessary first step towards understanding place-based health disparities.

## Introduction

We are still discovering how changes in our geographical location relate to our health. Geographical changes can happen *to* a person, by either staying in a geographical location that changes around them or moving to a new location. They can also happen *by* a person: when individuals move, not only do they experience a change in location, but they take their sociodemographic identities, income, health, employment, and education with them. As a result, the place they are leaving and the place they are arriving changes, if only slightly. In aggregate, composition changes at a geographic location could potentially change the health of the population as a whole. In this paper, we explore methods for accounting for composition changes due to migration when measuring average health outcomes across U.S. counties.

Measuring health outcomes has been important for guiding effective policy-making. The idea is to identify potential factors that may influence health so that policy-makers can design precise, well-founded strategies. In this regard, it is important for policy-makers to separate changes in average health outcomes that stem from the built environment as opposed to the composition of the population itself. If the built environment is the cause, enhancing access to parks, medical facilities, and public transport might be a solution. If, however, composition changes are the cause, policy-makers may want to learn about their the new residents. This insight will allow for a more tailored approach to meet their specific needs, such as providing affordable housing for low-income families. County-level data and analyses have been valuable tools in gaining this insight, serving to inform local policies on how to raise the average health of a county or reduce disparities within a county <!--# cite -->. This approach has proven especially valuable in the face of challenges like the COVID pandemic, where local entities like health departments, school boards, and faith-based organizations played a pivotal role in responding to public health needs based on county data.

Traditional approaches to county-level analyses of health involve autoregressive models that account for variation across space and time. The application of autoregressive models at the county level has seen various implementations, such as a county's relative position and historical mortality rates for forecasting future mortality rates [@yang2011], or estimating mortality rates that adjusts for county-level information on income and employment, population density and rurality, and race/ethnicity [@anappli]. Similarly, during the early stages of the COVID-19 pandemic, a spatial autoregressive model was utilized to assess the relationships between county-level COVID-19 mortality rates and county-level sociodemographic characteristics [@fielding-miller2020]. This modeling approach has also been applied to age-group and country-level data to explain cohort effects within countries[@li2021], and more recently, to enhance the estimation of country-level life expectancy, particularly for younger demographics, with improved efficiency and accuracy [@shi2021].

These modeling approaches, however, overlook the aspect of migration.  An important consideration is how much of the variation in a county’s average health outcomes could be attributed to the movement of individuals between regions. As a first hypothesis, we might anticipate that a person moving from a region with better (worse) average health outcomes to one with worse (better) average outcomes would increase (decrease) the average health outcomes of their destination, however slightly. If this is true, then models that ignore this source of variation may incorrectly attribute a change in average health outcomes to other factors, such as the built environment.  

A major drawback with this first hypothesis is that it assumes that when a person moves from one place to another, their health status is representative of the average health status of the place they are coming from. In other words, movers are neither more nor less likely to be healthier than the general population of their original location, making their health outcomes comparable to the average health outcomes of that area. Previous research suggests this assumption is not accurate, indicating that the health of migrants often differs from the average health of their origin in addition to the average health of their destination.

To start, migration can have a direct impact on the health of the individual moving. For example, relocation from rural areas to urban areas has been associated with increased risk of cardiovascular disease in some populations [@miranda2011]. Similarly, relocation to high-income countries has been associated with adverse cardiovascular health effects [@agyemang2019]. Several studies have found that rates of cardiovascular disease are higher among migrants than among their peers who did not migrate[@agyemang2022]. For instance, a study of people who migrated to the US from Japan found that Japanese migrants to California had age-adjusted prevalence rates of cardiovascular disease that were more than twice as high as their peers who migrated to Hawaii or did not migrate at all [@marmot1975]. This suggests that the average health of migratory populations becomes more similar to the average health of their destination than that of their origin, possibly because migrants take on the diets, habits, and other health factors of the place to which they relocate.

Another explanation is that people who move are systematically different than people who stay. That is, migration is not random, but selective. According to Lee’s theory [@lee1966], migration is influenced by “push” factors that compel people to leave their origins, due to hardships like job losses, climate events, or war, and by “pull” factors that attract people to new destinations, often favoring those with high income or education. Consequently, migration typically involves either the most advantaged or the least advantaged individuals. This logic might extend to the health of migrants: only the most and least healthy individuals migrate. For example, when the barriers between origin and destination are particularly high, migrants are often healthier on average than the people living in their destination, because unhealthy people are less likely to move when the barriers are high [@halliday2008]. In the aforementioned study of migrants from Japan, for instance, it is possible that people who migrated to California were “pushed” to California while people who migrated from Japan to Hawaii were “pulled” to Hawaii.  

Because migration is selective, a second hypothesis might be that certain factors about a county help explain the relationship between average health of a county and the average health of the counties from which people are moving.  For example, migrants who move from more resource depleted regions to less resource depleted regions often have better health on average than the population in their destination while migrants who move from less depleted regions to more depleted regions have worse health on average than the population in their destination [@norman2005]. One specific factor of interest is urbanicity, because, for one reason, urban and rural regions differ in their average health. For instance, higher rates of high quality of life in Finland were found in rural areas but not after controlling for perceived loneliness[@weckroth2022], and people in urban areas have higher prevalence of both depression and anxiety despite a lower prevalence of other risk factors [@zijlema2015]. For another reason, urban and rural regions differ in ways that relate back to the health of their population, such as access to green space[@tsai2018]; concentration of populations marginalized from resources, crowded living conditions, and air pollution[@ha2017]; access to social organizations[@yang2019], and educational and financial opportunities[@ha2019]. Therefore, if the second hypothesis is true, then we may want to let county factors, like urbanicity, modify how compositional changes due to migration relate to average county health in our modeling. 

Still, even if we accounted for county factors, there may still be *unobserved* factors at play. For example, some people may choose to live in urban places and others in rural environments. These choices could be influenced by the past and present sociocultural context of each community which affects who feels welcomed into which communities. Factors such as personality and familial ties play large roles in both health and choice of living location [@chan1977]. Thus, we arrive at a third hypothesis, in which unobserved factors help explain the relationship average health of a county and the health of the counties from which people are moving. If true, then we may want to investigate the potential for unobserved factors to modify how compositional changes due to migration are incorporated into the model. 

In this paper, we propose novel extensions of traditional spatiotemporal models to account for compositional changes due to migration. Our broad strategy is to use migration flows in and out of counties to adjust the autoregressive term in the model in a principled way. By way of this strategy, we are able to first, formalize and, then, test three hypotheses:

1.  County-to-county migration flows improve the explainability of autoregressive models of county-level health outcomes.

2.  The role that county-to-county migration flows plays in county-level health outcomes differs significantly between rural and urban counties.

3.  Taking into account unmeasured factors in county-to-county migration flows improves our ability to explain county-level health outcomes as well as the differential role that migration plays in urban versus rural counties.

We note these hypotheses mirror the three broad hypotheses introduced earlier. Using publicly accessible mortality data from CDC WONDER [@cdcwond]and county-to-county migration flow data from the IRS [@soitax], we investigate these hypotheses, focusing specifically on county-level premature age-adjusted mortality and on using Bayesian information criteria (BIC) as a measure of model fit. Through this investigation, we seek to demonstrate our strategy for incorporating migration into spatiotemporal models of average health. Additionally, we seek to determine what our modeling strategies reveal about the relationship between county-to-county migration and county-level premature age-adjusted mortality, especially as it relates to urbanicity and the possible influence of unmeasured factors. 

## Methods

#### Data and Variables

All of the data used in these analyses is publicly accessible. We use county-level estimates of premature age-adjusted mortality available through the CDC WONDER Underlying Cause of Death 1999-2020 database[@underlyi] joined with IRS county-to-county migration flow data[@soitax].

[The outcome of interest is county-level age-adjusted rates of premature mortality]{.underline} We refer the age-adjusted premature mortality rate for each destination county $i$ at year $t$ as $y_{it}$. Premature mortality is defined as any death occurring before age 75. Age-adjusted rates of premature mortality are commonly used as a gold standard when comparing various dimensions of health across counties since death has a clear and common definition [@self-rat1997; @jylhä2009; @olson-williams2023], and since premature age-adjusted mortality has important policy and health equity implications and can be used to assess which individuals or groups are likely to live longest and which individuals or groups may be most in need of additional care. For our analyses, we excluded years after and including 2020 because the onset of the pandemic is unrelated to other factors included in our model. Additionally, to match migration data, we excluded years prior to 2011. Therefore, we include premature age-adjusted mortality rates for 8 years total (2011 through 2019) for each destination county $i$.

A necessary baseline explanatory factor is [lagged premature age-adjusted mortality]{.underline}, which we refer to as $y_{i,t-1}$. This is our autoregressive term. In order to predict future age-adjusted rates of premature mortality, we use the age-adjusted premature mortality rate of the prior year $(t-1)$ for each destination county $i$.

[An explanatory factor of interest is urbanicity.]{.underline} To assess urbanicity, we assign each county an urbanicity category based on the 2013 National Center for Health Statistics (NCHS) Urban–Rural Classification Scheme for Counties [@rothwell]. To maximize the number of counties per category and improve precision, we chose to use only two urbanization categorizations: urban and rural, where urban includes large central metro, medium metro, and small metro counties, and rural includes micropolitan and noncore counties. We assessed `r length(unique(migterm_imp$destid[migterm_imp$rural == 1]))` unique rural counties and `r length(unique(migterm_imp$destid[migterm_imp$rural == 0]))` unique urban counties.

[The primary explanatory factor of interest is the *migration term*]{.underline} which we refer to as $mig_{it}$. We calculate $mig_{it}$ for each destination county $i$ during each year $t$ using the following equation: The migration term $mig_{it}$ accounts for the premature age-adjusted mortality rates of individuals who have moved to a county of interest during a given period. This term is essentially a weighted average of the mortality rates of all of the origin counties $j$ for a given destination county $i$. We calculate the following for each change in year $t$ and for each destination county $i$:

$$  mig_{it} = \frac{ \sum_{j\ne i} out_{jit} y_{j,t-1} + y_{i,t-1} (pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} $$ {#eq-mig}

where $y_{i,t-1}$ is the lagged premature age-adjusted mortality rate of destination county $i$ as defined above and $pop_{i, t-1}$ is the population under age 75 of an unique destination county $i$ at initial year $t-1$. Both $y_{i,t-1}$ and $pop_{i,t-1}$ come from the CDC WONDER Underlying Cause of Death database. The $out_{ijt}$ term represents the number of migrants from a unique origin county $j$ who migrated to a destination county $i$ between year $t-1$ and year $t$. The values of $out_{ijt}$ come from IRS migration flow data from 2011 through 2019. We exclude years prior to 2011 because in 2011 the IRS changed their methods to produce migration estimates based on a full year of income tax filings rather than a partial year. Prior to 2011, migration estimates represented between 95 and 98 percent of total annual income tax filings and excluded income taxes filed after September of each calendar year [@pierce2015]; estimates after 2011 include all annual income tax filings collected for each year. Therefore, we have chosen only to include data after the 2011 change in IRS methodology. We have chosen to use IRS rather than ACS estimates of migration because ACS does not publish single year estimates of migration (only five year estimates), we want to emphasize the temporal aspects of migration, necessitating the use of IRS single year estimates. <!--# something here about the percent of americans who file taxes each year -->

<!--# perhaps smig should go here -->

Since we are particularly interested in spatial trends in premature mortality and migration, we exclude counties from Hawaii and Alaska and include only contiguous counties. Additionally, to avoid systematically excluding counties with small population size and to ensure that we have balanced panel data, we used the mice R package[@mice] to impute lagged premature age-adjusted mortality rates $y_{i,t-1}$ for counties with missing values. There are a total of `r length(unique(migterm_imp$destid))` US counties included in our analyses.

<!--# The map below shows the most recent year of premature age-adjusted mortality rates for the counties included in our analyses. This map also highlights the spatial distribution of county-level premature age-adjusted mortality rates across the United States where Southwestern counties tend to have higher rates of premature mortality than counties in the Midwest and Northeast. -->

## Model fitting

Using the data and variables outlined above, we first established a baseline autoregressive spatial error model of county-level premature age-adjusted mortality $y_{it}$. The [**baseline model**]{.underline} is as follows:

$$  y_{it} = \beta_0 + \beta_{1t} + \beta_{2}y_{t-1,i} + \mu_{i} + \epsilon_{it}    $$ {#eq-baseline}

where $\beta_0$ is the intercept, $\beta_{1t}$ is a coefficient for the affect of each year $t$ on county-level premature age-adjusted mortality $y_{it}$, $\beta_2$ is a coefficient for the effect of lagged premature age-adjusted mortality on predicted premature mortality, $\mu_i$ is a random intercept for each destination county $i$, and $\epsilon_{it}$ represents an error term accounting for spatial dependencies. We define the equation for spatial dependency as follows:

$$ \epsilon_{it} = \lambda W \epsilon_{it} + u_{it}   $$ {#eq-spatialerror}

Thus, the magnitude of spatial dependency results from the product of a scalar $\lambda$, the spatial autoregressive parameter, which is close to 0 when there is no spatial interdependence and increases as spatial interdependence grows, and $W$, a spatial weights matrix with row-standardized weights. We created $W$ using the `spdep` R package [@spdep] with the "queen" criterion which considers counties that share any point as neighbors. Finally, $u_{it}$ represents the spatially independent random error term for each county $i$ at year $t$.<!--# need more context here -->

We created this baseline model and all subsequent models using the `splm` and `splines` R packages [@splines; @splm-2]. To establish a model with the most explanatory power, we began by iteratively adding splines with two to five degrees of freedom for the lagged age-adjusted county-level premature mortality rates $y_{i,t-1}$ to capture potential nonlinear trends over time. We compared models using the Bayesian Information Criterion (BIC), which is commonly used to identify models with the greatest explanatory power[@kuha2004].

Next, we added the migration term $mig_{it}$ to this baseline model. We again attempted to capture nonlinear trends over time by iteratively adding splines with two to five degrees of freedom for the lagged age-adjusted county-level premature mortality rates $y_{i,t-1}$ and the migration term $mig_{it}$. <!--# We observed that keeping the degrees of freedom equal for the splines of both $y_{it}$ and $mig_{it}$ resulted in lower BIC scores, indicating better model fit, so we tested models where the degrees of freedom for $mig_{it}$ and $y_{it}$ were equal.  does this go in results instead?--> The addition of this weighted average migration term to our model allows us to implicitly account for between-county selection for migration. However, $mig_{it}$ does not account for within-county selection of migrants. In other words, our best guess for the mortality rate of migrants is exactly the mortality rate of their original county; meanwhile, some counties are more likely to be destinations for migration than others.

To determine whether the role that county-to-county migration flows play in county-level health outcomes differs significantly between rural and urban counties (Hypothesis 2), we added a factor term for urbanicity including interaction terms between urbanicity and $y_{i,t-1}$ and urbanicity and $mig_{i,t}$. We again compared these models using BIC while iteratively adding splines with two to five degrees of freedom for migration and lagged premature mortality. We chose a final model for our simulation of health-related selection based on BIC score and stability. This model is as follows:

$$  y_{it} = \beta_0 + \sum_{k=1}^{K} \beta_{1k} \cdot \text{ft}_{k} + \sum_{k=1}^{K} \beta_{2k} ns(y_{t-1,i}, 2) \cdot r_i^{k} + \sum_{k=1}^{K} \beta_{3k} ns(migterm_{it}, 2) \cdot r_i^{k} + \sum_{k=1}^{K} \beta_{4k} r_i^{k} + \mu_i + \epsilon_{it} + \lambda W \epsilon_{it} + u_{it} $$ {#eq-forsimulation}

where (in addition to the terms defined in our baseline model) $r_i$ is a binary indicator variable equal to 1 for rural destination counties and 0 for urban destination counties, $ns(y_{t-1,i}, 2)$ is a natural spline transformation of the lagged premature age-adjusted mortality rate with 2 degrees of freedom, and $ns(migterm_{it}, 2)$ is a natural spline transformation of the migration term with 2 degrees of freedom.

Finally, to determine whether taking into account unmeasured factors in county-to-county migration flows improves our ability to explain county-level health outcomes (Hypothesis 3), we added parameters $k_{ij}$ and $l_i$ to the premature mortality rate of each origin $j$ and each destination $i$ within our equation for the migration term. We call this new [**simulated migration term**$smig_{it}$**.**]{.underline} The equation for $smig_{it}$ is shown below:

$$  smig_{it}(k_{ij}, l_i) = \frac{ \sum_{j\ne i} out_{jit} ( y_{j,t-1} + k_{ij}) + (y_{i,t-1} + l_i) (pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} $$ {#eq-smig_kl}

We use $smig_{it}$ to simulate within-county selection for migration: when the parameter $k_{ij}$ is subtracted (ie decreased mortality rate), we simulate migration by individuals who are healthier than the average of their origin $j$. When the parameter $k_{ij}$ is added (ie increased mortality rate), we simulate migration by individuals who are unhealthier than the average of their origin $j$. Likewise, when the parameter $l_i$ is subtracted (ie decreased mortality rate), we simulate migration by individuals who are healthier than the average of their destination $i$. When the parameter $l_i$ is added (i.e., increased mortality rate), we simulate migration by individuals who are unhealthier than the average of their origin $i$. We specify that $k_{ij}$ depends on both origin $j$ and destination $i$ since health related selection for migration is connected to both the origins and the destinations of counties; meanwhile $l_i$ is dependent only upon the health of destination $i$.

Since we are most interested in how the values of $k_{ij}$ and $l_i$ are related to each other, we chose to simplify $smig_{it}$ such that $l_i$ is held constant and only $k_{ij}$ fluctuates. Therefore, we assign the parameter $d_{ij}$ to be the difference between $k_{ij}$ and $l_i$, thus creating a new equation for $k_{ij}$ in terms of $l_i$ and $d_{ij}$ such that $k_{ij} = l_i+ d_{ij}$. The value of $d_{i,j}$ can be thought of as a modeling term to explain health-related selection bias. <!--# amy's phrasing: "refer to the dij as a modeling term that models health related selection bias" -->Then our equation for $smig_{it}(k_{ij})$ becomes:

$$  smig_{it}(l_i+d_{ij}, l_i) = \frac{ \sum_{j\ne i} out_{jit} ( y_{j,t-1} + l_i + d_{ij}) + (y_{i,t-1} +l_i)( pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} $$ {#eq-smig_ldl}

which can be simplified into the following:

$$  smig_{it}(d_{ij}) = \frac{ \sum_{j\ne i} out_{jit} ( y_{j,t-1} + d_{ij}) + y_{i,t-1} (pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} +l_i$$ {#eq-smig_d}

Therefore, using the equation above, we simulate health-related selection occurring as a result of the differences in health between the origin and the destination counties. When $d_{ij}$ is positive, we estimate that the origin is less healthy than the destination. When $d_{ij}$ is negative, we estimate that the origin is healthier than the destination.

To determine which values of $d_{ij}$ best explain trends in county-level premature mortality rates, we replace $mig_{it}$ (@eq-mig) with $smig_{it}(d_{ij})$ (@eq-smig_d) in the model with the most explanatory power, @eq-forsimulation, as determined in our previous model selection steps. We tested many potential values of $d_{ij}$. We began by incrementing by 50 from -200 to 200 such that migrants had an estimated premature mortality rate that was between 200 premature deaths per 100,000 population higher and 200 premature deaths per 100,000 population lower than their origin county.

To understand this phenomenon further, we next conducted a grid search to test potential values of $d_{ij}$ when accounting for urbanicity. Specifically, we examined how the values of $d_{ij}$ vary based on the urbanicity of both the origin and destination counties. We defined these variations as follows: $d_{uu}$ for the difference in average health between an urban origin and an urban destination, $d_{rr}$ for the difference in average health between a rural origin and a rural destination, $d_{ru}$ for the difference in average health between a rural origin and an urban destination, and $d_{ur}$ for the difference in average health between an urban origin and a rural destination.

We began with a broad increment of 50, testing \$d\_{ij}\$ values ranging from -200 to 200 premature deaths per 100,000 higher than the destination county, resulting in 6,561 unique sets of \$(d\_{uu}, d\_{rr}, d\_{ru}, d\_{ur})\$. After identifying a range of \$d\_{ij}\$ values that minimized the BIC score, we refined our search. Using a smaller increment of 20, we tested \$d\_{uu}\$ values within a range of -140 to 20 age-adjusted premature mortality rate different from the destination county and values of \$d\_{ur}\$, \$d\_{rr}\$, and \$d\_{ru}\$ within a range of -80 to 80, resulting in another 6,561 unique sets of $(d_{uu}, d_{rr}, d_{ru}, d_{ur})$. ~~Finally, observing trends in BIC for models with \$d\_{ij}\$ values between -40 and 40, we noted patterns suggesting the lowest BIC score might result from \$d\_{ru}\$ and \$d\_{ur}\$ values outside this range. Thus, we performed another refined search, holding \$d\_{uu}\$ and \$d\_{rr}\$ constant at 0 and iterating from 0 to 100 by 5 for both \$d\_{ur}\$ and \$d\_{ru}\$, resulting in an additional 441 unique sets of~~ $(d_{uu}, d_{rr}, d_{ru}, d_{ur})$~~.~~ <!--# flowchart here???? -->

### [**Results and Conclusions**]{.underline}

The tables below present descriptive statistics for $y_{it}$​ (premature age-adjusted mortality rate) and migration rates for each year and categorized by county type (rural, urban). Note that migration rates for the year 2011 are not included. This is because the migration-flow data starts from 2011 to 2012, and these values are shown in the 2012 section of the table, corresponding with the 2012 premature age-adjusted mortality rates.

```{r table1 as dreamed up by chatgpt }

library(tidyverse)
library(ggplot2)
library(table1)

load("data_processed/migterm_imp.Rdata")

migterm_imp$migrat = as.numeric(migterm_imp$totin_d)/as.numeric(migterm_imp$pop_d0)*1000

migterm_imp = migterm_imp %>% 
   mutate(
    rural = factor(rural, levels = c(0, 1), labels = c("Urban", "Rural"))
  )

# Define labels for the table
table1::label(migterm_imp$destid) = "County"
table1::label(migterm_imp$year) = "Year"
table1::label(migterm_imp$migrat) = "Migration rate"
table1::label(migterm_imp$rate_d1) = "Premature age-adjusted mortality rate"
table1::label(migterm_imp$rural) = "Urban/Rural"

# Define units for the columns
table1::units(migterm_imp$migrat) <- "per 1,000"
table1::units(migterm_imp$rate_d1) <- "per 100,000"

# Filter data for rural
rural_data <- migterm_imp %>% filter(rural == "Rural")

# Filter data for urban
urban_data <- migterm_imp %>% filter(rural == "Urban")

# Generate the table for rural with title
table_rural <- table1::table1(~ migrat + rate_d1 | year, 
                              data = rural_data, 
                              overall = "Total", 
                              title = "Rural Counties",
                              caption = "Migration rate and mortality rate stratified by year for rural counties")

# Generate the table for urban with title
table_urban <- table1::table1(~ migrat + rate_d1 | year, 
                              data = urban_data, 
                              overall = "Total", 
                              title = "Urban Counties",
                              caption = "Migration rate and mortality rate stratified by year for urban counties")

# Display the tables
table_rural
table_urban

```

After examining the data, our first goal was to establish that our migration term added explainability (as measured by lower BIC scores) to our most basic autoregressive model accounting for spatial error. We observed that models including splines with equal degrees of freedom for both the migration term and the lagged premature mortality rate resulted in consistently lower BIC scores than models with splines with unequal degrees of freedom. The best fitting model in terms of BIC score included splines with four degrees of freedom for both the autoregressive term and our weighted average migration term. This indicates that models incorporating migration had more explanatory power than models that included only the prior year's average county-level mortality rate.

Next, we sought to determine whether our migration term would improve the explainability of our spatiotemporal model, even after accounting for urbanicity. We added interaction terms between urbanicity and lagged premature mortality and urbanicity and migration. After adjusting for urbanicity, we found that the models with the lowest BIC scores included splines with four degrees of freedom each for the migration term and lagged age-adjusted mortality. This further confirmed that the migration term added explainability to our models, even when accounting for urbanicity.

The plot below demonstrates lower BIC scores for models that include the migration term along with an interaction between $y_{it}$ and urbanicity. The difference in BIC scores between models that include the migration term and those that do not is more pronounced when an interaction term for urbanicity is added. This suggests that the migration term significantly enhances model explainability when accounting for urbanicity, indicating that the relationship between average county-level health and migration may differ substantially across urbanicity levels.

```{r spatial models only, echo = FALSE, warning = FALSE, message = FALSE}

#need to find a way to fix the yi,t-1 label on the x axis 
# also need to add the "REF" at 0 on the plot so it's obvious what we're comparing to 

spatonly = read.delim("chtc_outputs/modselection_nat.txt", sep = ",")  
ref = spatonly$BIC[spatonly$Model == "fnom"] 

spatonly$refbic = round(spatonly$BIC - ref, 2)   



tf <- spatonly %>%
  mutate(
    `Migration Included` = !grepl("_nomig|nom", Model),
    `Degrees of Freedom` = str_extract_all(Model, "\\d+"),
    `BIC score relative to reference` = refbic,
    `Urbanicity interaction` = grepl("r", Model)
  )
# Convert the list of numbers to a single string or set to "1" if no number is found
tf$`Degrees of Freedom` <- sapply(tf$`Degrees of Freedom`, function(x) {
  if (length(x) == 0) {
    return("1")
  } else {
    return(paste(x, collapse = " "))
  }
})

tf = tf %>% select(`Migration Included`, `Degrees of Freedom`, `BIC score relative to reference`, `Urbanicity interaction`)


tf$`BIC score relative to reference`[tf$`BIC score relative to reference` == 0] = "REF"


tf = tf %>% arrange(`Degrees of Freedom`, `Migration Included`, `Urbanicity interaction`)

ggplot(data = tf, aes(x = `Degrees of Freedom`, 
                      y = as.numeric(`BIC score relative to reference`), 
                      color = `Migration Included`,
                      size = `Urbanicity interaction`,
                      label = ifelse(`BIC score relative to reference` == "REF", "REF", ""))) +    
    geom_point(alpha = 0.6) +  # Include alpha within geom_point
    geom_text(color = "black", size = 5, fontface = "bold", 
              nudge_y = 0.05, check_overlap = TRUE) +  # Add text labels with adjustments
    theme_bw() +
    labs(x = expression(paste("DF for splines for ", y[i,t-1], " and ", mig[it])), y = "BIC relative to reference",
         color = "", size = ""
    ) +
    scale_color_manual(
        values = c("TRUE" = "darkblue", "FALSE" = "darkred"),
        labels = c("TRUE" = "Including migration term", "FALSE" = "Excluding migration term"),
        guide = guide_legend(title = NULL)
    ) +
    scale_size_manual(
        values = c("TRUE" = 5, "FALSE" = 2),
        labels = c("TRUE" = "Including urbanicity interaction", "FALSE" = "Excluding urbanicity interaction"),
        guide = guide_legend(title = NULL)
    ) +
    guides(
        color = guide_legend(order = 1), 
        shape = guide_legend(order = 2), 
        size = guide_legend(order = 2),
        alpha = "none"
    ) +
    coord_cartesian(ylim = c(min(as.numeric(tf$`BIC score relative to reference`), na.rm = TRUE) * 1.1, 0)) 

```

In the plot above, we see that the difference in the BIC scores of models with splines with two degrees of freedom and models with splines with four degrees of freedom for $y_{i,t-1}$ and $mig_{it}$ is only `r abs(round(spatonly$BIC[spatonly$Model == "fff4r"] - spatonly$BIC[spatonly$Model == "fff2r"], 1))`. Due to concerns about potential overfitting, and since there appears to be little explainability <!--# maybe need a citation or something here??? --> added by additional degrees of freedom, we chose to use a model with splines with two degrees of freedom for lagged premature mortality rate and migration term, thus, we settled on the model @eq-forsimulation.

After replacing $mig_{it}$ (@eq-mig) with $smig_{it}(d_{ij})$ (@eq-smig_d) in @eq-forsimulation, and testing values of $d_{ij}$ between -200 and 200 iterating by 50, we found that the model with the most explanatory power had $d_{ij} = 0$. As the magnitude of the difference between the health of origin and destination increased, our models had less explanatory power as measured by higher BIC scores. This is shown in the plot below. This suggests that, according to our models, health-related selection for migration may not be important to modelling county-level health when we do not account for urbanicity.

```{r ksim without urb, just k, echo = FALSE}
#this might have to be removed or updated since it uses 4df 

load("data_processed/bick_nourb_tot.Rdata")

ggplot(data = bick_nourb_tot, aes(x = as.numeric(newk), y = as.numeric(bicspat))) +
  geom_point() +
  theme_bw() + 
  labs(x = expression(d[ij]), 
       y = "BIC score")

```

To explore the possibility of health-related selection further, we conducted a second simulation, in which we varied \$d\_{ij}\$ for each possible combination of origin and destination type: rural-to-urban, rural-to-rural, urban-to-rural, and urban-to-urban. In the plot below, we see the number of destination counties for each migration type over time. Notably, the rural-to-rural migration type has the most unique destination counties because there are more rural counties than urban counties. This approach allows us to emphasize all counties, instead of focusing primarily on urban migration, which is more commonly studied.

```{r {migtype by year}
load("data_processed/imputed_for_ksim.RData")

#this dataset is called natmorturb_imp
# it has natality, death, population, premature mortality rates, migration flows, rural/urb codes but no migterms (yet)
# it is balanced and has no missing rates (except for initial years)

urbcodes = haven::read_sas("data_raw/nchs_urbanicity_wlabels.sas7bdat") %>% 
  select(fipscode, rural) %>% 
  rename(rural_orig = rural)
#add rural/urb for origin 
nm = natmorturb_imp %>% rename(rural_dest = rural) %>% 
  left_join(urbcodes, by = join_by(origid == fipscode)) %>% 
  mutate(migtype = ifelse(!is.na(rural_dest)& !is.na(rural_orig), paste0(rural_dest, rural_orig), NA)) 


migtypecounts = nm %>% group_by(migtype, year) %>% 
  summarize(n_distinct(destid)) %>% 
 # filter(year !=2011) %>% # these nas are for getting the initial
  filter(!is.na(migtype)) %>% #these nans are just for getting the starting pop and mort vals for each county for each year 
  mutate(year = as.numeric(year))

# Define mapping for migtype labels
migtype_labels <- c("00" = "Urban-to-urban",
                    "11" = "Rural-to-rural",
                    "10" = "Urban-to-rural",
                    "01" = "Rural-to-urban")
my_palette <- c("#1f78b4", "#33a02c", "#e31a1c", "#ff7f00")

ggplot(data= migtypecounts) + 
  geom_point(aes(x = year, y = `n_distinct(destid)`, color = migtype)) + 
  geom_line(aes(x = year, y = `n_distinct(destid)`, color = migtype)) + 
  scale_x_continuous(breaks = unique(migtypecounts$year), labels = function(x) paste0(x - 1, " - ", x)) +
  scale_color_manual(values = my_palette, labels = migtype_labels) +
  labs(x = "Year", y = "Count of unique destination counties", color = "") +
   theme_bw() +
  theme(axis.text.x = element_text(angle = 20, hjust = 1)) 

#urban to urban is basically flat because basically all urban counties are linked by migration 
# there are 1159 unique urban destids in the dataset: nm %>% filter(rural_dest ==0) %>% summarize(n_distinct(destid))
# and 2011-2012 and 2012-2013 appear similar but they do in fact have different values (no error here) 
```

In our urbanicity-specific simulation, we again incremented by 50 from -200 to 200. In the plot below, we see the relationships between BIC score and $d_{ij}$ for each migration type while holding $d$ for all other migration types constant at 0. For migration to rural destinations (represented by orange $d_{rr}$ and red $d_{ru}$), the minimum BIC score occurs when there is no difference in health between origin and destination. However, for migration to urban destinations, there is some evidence of lower BIC scores when urban origins have slightly lower age-adjusted premature mortality rates than their correpsonding urban destinations (represented by $d_{uu}$). In this case, movers tend to migrate from healthier urban counties to less healthy urban counties.

```{r}
#load("data_processed/bick_restrict.Rdata")
load("data_processed/bickdf.Rdata")
# Combine the datasets and convert columns to numeric
#bicktot <- rbind(bick_restrict, bickdf) %>%
 bicktot = bicktot %>%  mutate(
    kur = as.numeric(kur),
    krr = as.numeric(krr),
    kuu = as.numeric(kuu),
    kru = as.numeric(kru)
  )

# Find the most explanatory set
mostex <- bicktot %>% filter(bicspat == min(bicspat))


# Create a combined dataset for plotting
bicmin_kuu <- bicktot %>% filter(kru == 0 & krr == 0 & kur == 0) %>% mutate(type = "kuu")
bicmin_krr <- bicktot %>% filter(kru == 0 & kuu == 0 & kur == 0) %>% mutate(type = "krr")
bicmin_kur <- bicktot %>% filter(kru == 0 & krr == 0 & kuu == 0) %>% mutate(type = "kur")
bicmin_kru <- bicktot %>% filter(kur == 0 & krr == 0 & kuu == 0) %>% mutate(type = "kru")

# Combine the datasets for plotting
bicmin_combined <- bind_rows(bicmin_kuu, bicmin_krr, bicmin_kur, bicmin_kru)

# Plot
ggplot(bicmin_combined, aes(x = as.numeric(case_when(
  type == "kuu" ~ kuu,
  type == "krr" ~ krr,
  type == "kur" ~ kur,
  type == "kru" ~ kru
)), y = as.numeric(bicspat), color = type)) +
  geom_point() +
  geom_line() +
  xlab(expression(d[ij])) +
  ylab("BIC") +
  theme_bw() +
  labs(subtitle = expression(paste("Relationship between BIC and ", d[ij], "\n (assuming that other parameters are held constant at 0)")),
       title = "Urban-Rural Migration") +
  scale_color_manual(values = c("kuu" = "#1f77b4", "krr" = "#ff7f0e", "kur" = "#2ca02c", "kru" = "#d62728"),
                     labels = c("kuu" = expression(paste(d[uu], " when all other parameters are held constant at 0")),
                                "krr" = expression(paste(d[rr], " when all other parameters are held constant at 0")),
                                "kur" = expression(paste(d[ur], " when all other parameters are held constant at 0")),
                                "kru" = expression(paste(d[ru], " when all other parameters are held constant at 0")))) +
  guides(color = guide_legend(title = NULL))
```

Based on the trends shown in the plot above, we narrowed our search increment to 20 and tested \$d\_{uu}\$ values within a range of -140 to 20 age-adjusted premature mortality rate different from the destination county and values of \$d\_{ur}\$, \$d\_{rr}\$, and \$d\_{ru}\$ within a range of -80 to 80, resulting in another 6,561 unique sets of $(d_{uu}, d_{rr}, d_{ru}, d_{ur})$. The results of this narrowed search are shown below:
