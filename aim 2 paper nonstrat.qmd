---
title: "Migrational-temporal models of county-level health"
date: ""
author: "Hannah Olson-Williams, Amy Cochran"
format: docx  
editor: visual
bibliography: references.bib
---

<!--# perhaps should add: -->

<!--# some explanation of spatial error versus spatial lag -->

<!--# packages used to assess each aim -->

### Abstract

Although the relationship between place and health is well studied and measured, typical place-based measures of health are static, representing a single point in time without accounting for movement or mobility. Among the well-established understanding that place influences health is the understanding that place differentially impacts some groups of people more than others. What remains unknown is to what extent population migration explains place-based health and health disparities. Thus, there is a critical need to measure the degree to which county-level patterns in health factors and outcomes can be attributed to county-level patterns in mobility. Without such knowledge, we are unable to fully capture the complexities of county-level health, limiting our ability to inform local policy making.

This paper aims to provide understanding of the mechanisms by which mobility may be related to place-based health disparities so that local decision-makers may account for patterns in mobility when creating policy towards improved health for all people in all places. In this paper, we quantify and devise techniques for quantifying the relationship between county-level mobility and county-level health. Our central hypothesis is that poor county-level health factors and outcomes are associated with extremely high and extremely low rates of county-level mobility. Understanding rural-urban mobility patterns is a necessary first step towards understanding place-based health disparities.

### **Background and Significance**

Much of physical and mental health is place-based. There are well-established relationships between the built-environment and health outcomes. However, less is understood about how changes in place can affect health. Changes in place can occur both *to* and *by* people: when individuals relocate, not only do they experience a change in place, but they take their sociodemographic identities, income, health, employment, and education with them. As a result, the population, culture, and health of the place they are leaving and the place they are arriving changes, if only slightly. In aggregate, these migration-related changes could potentially change the health of the population as a whole. In this paper, we aim to measure the effects of migration on county-level measures of health.

As individuals move from one place to another, the resources in their counties of origin and destination change. Therefore, the relationship between health and place can be viewed as "mutually reinforcing and reciprocal"[@cummins2007]. For instance, when individuals relocate, they bring their social connections with them[@dehaas2010]. These social connections might lead to greater migration and more people (resources) in the future which could lead to better health outcomes on average and increased "pull" of the destination. The idea that migration can be self-perpetuating has been explored many times in the past[@dehaas2010a; @dehaas2021] mostly to describe "pull" factors -- factors that make a location more desirable after migration has occurred. The perceived average health of a community may be one of these "pull" factors.

Previous research has found that the health of migrants often differs from the average health of their origin and the average health of their destination. For instance, relocation from rural areas to urban areas has been associated with increased risk of CVD in some populations.[@miranda2011] Similarly, relocation to high-income countries has been associated with adverse cardiovascular health effects.[@agyemang2019] Several studies have found that rates of CVD are higher among migrants than among their peers who did not migrate.[@agyemang2022] For instance, a study of people who migrated to the US from Japan found that Japanese migrants to California had age-adjusted prevalence rates of CVD that were more than twice as high as their peers who migrated to Hawaii or did not migrate at all.[@marmot1975] This suggests that the average health of migratory populations becomes more similar to the average health of their destination than that of their origin, possibly because migrants take on the diets, habits, and other health factors of the place to which they relocate. Another possible explanation is that people who migrated from Japan to California were "pushed" to California while people who migrated from Japan to Hawaii were "pulled" to Hawaii.  

Income inequality has been found to be associated with poor health among some populations.[@zimmerman2006] Populations that experience high levels of income inequality may also experience declining rates of migration, as shown by Cooke 2013.[@cooke2013] Therefore, the effects of migration on health may be mediated by income inequality. Additionally, Lee's theory of migration suggests that regions with high levels of diversity are more likely to experience high rates of migration since migration is associated with imbalance between the origin and the destination and since diverse groups of people typically gravitate towards individuals like themselves.[@lee1966] Therefore, though perceived health may operate as a "pull" factor, not all people in a community are likely to experience improved health.  

There are many potential mechanisms by which urbanicity and the movement between rural and urban places could impact health. One might expect worse health in urban areas considering that limited access to green space [@tsai2018], concentration of populations marginalized from resources, crowded living conditions, and air pollution[@ha2017] are associated with negative health outcomes. On the other hand, urban populations are also more likely to have access to health care, more likely to participate in social organizations which offer psycho-social support [@yang2019], and more likely to have educational and financial opportunities [@ha2019], all of which are associated with positive health outcomes. A recently published paper assessing quality of life in Finland found higher rates of high quality of life in rural areas but not after controlling for perceived loneliness [@weckroth2022]. Another study found that people in urban areas have higher prevalence of both depression and anxiety despite having lower prevalence of other risk factors [@zijlema2015]. Disentangling the contribution of each of these potential mechanisms has important public health implications by pointing to possible solutions (e.g., increase access) for improving health. Relating migration to health in the US, however, requires confronting several challenges. Migration is a complex phenomenon, and its effects are impossible to isolate completely. There are many potential variables that confound the relationship between migration and health. Most notably, counties that differ in migration patterns will also differ in the sociodemographic makeup of their population in terms of distributions of racial identity, age, income, and education. Even controlling for observed sociodemographic differences, there may still be *unobserved* confounding variables. For example, some people may choose to live in urban places and others in rural environments. These choices could be influenced by the past and present sociocultural context of each community which affects who feels welcomed into which communities. Factors such as personality and familial ties play large roles in both health and choice of living location [@chan1977]. Thus, analyses and conclusions must be carefully crafted to account for the complexity of where people move and why.

According to Lee's theory of migration [@lee1966], migration is selective, meaning that the individuals who migrate are not a random sample of the population of the origin. Migration occurs in response to a "push" or a "pull" -- migrants are "pushed" to leave an origin and "pulled" to a destination. "Pull" factors are more often associated with positive selection; migrants who are "pulled" to a destination due to perceived benefits are more likely to have high income or education status. Contrarily, migrants who are "pushed" to leave an origin are likely to have faced hardship in some form. In some cases, this is a negatively selected group including individuals who have lost jobs or suffered from climate change events; in other cases, an entire population may be "pushed" to migrate due to war or famine. Migration is often bimodal in that only the most advantaged and the least advantaged individuals relocate. This logic could be extended to the health distribution of migrants: only the most and least healthy individuals migrate. According to Norman and colleagues, migrants who move from more resource depleted regions to less resource depleted regions have better health on average than the population in their destination while migrants who move from less depleted regions to more depleted regions have worse health on average than the population in their destination [@norman2005]. Additionally, when the barriers between origin and destination are particularly high, migrants are often healthier on average than the people living in their destination, either because they have been selected through the migration process or because unhealthy people are less likely to choose to move when the barriers are high [@halliday2008]. Without understanding the individual decisions or circumstances that lead to migration, we cannot assess whether changes in health are the result of a "push" or a "pull." Disentangling the directionality of changes in health versus changes in migration is one challenge of using county-level data.

Since we propose an ecological study using county-level data, we can only adjust for county-level differences and cannot attempt to measure individual-level differences. County-level data can be useful to understand how place is related to average health. In particular, county-level analyses may be useful in informing local policies to raise the *average* health of a county, and county-level sociodemographic analyses may be useful in informing local policies to reduce disparities within a county -- thus, county-level analyses are useful in addressing both of the primary goals of population health: increasing the health of the population overall and reducing health disparities [@kindig2017]. As we have seen during the COVID pandemic, local public health departments, school boards, and faith-based organizations have the power to make decisions which affect public health at an "average" level. County-level analyses may help local decision-makers understand the patterns and processes of their communities. Additionally, because we use a dataset which contains all 3142 US counties, rural counties are better represented than urban counties despite having smaller total population. We use county-level data because that is what is available, but also because we cannot know exactly which individuals are in each county at time 0 and at time 1, which results in treatment and outcome groups that differ at the individual-level but not at the county-level.

Of course there is information lost when using group-level data, and the downsides of such an ecological study design have been enumerated many times previously [@greenland1989]; however, by studying county-level data, we can draw attention to environmental county-level health factors - factors that are likely to have different effects when comparing individuals but may remain largely constant when comparing groups or counties. <!--# more here about ecological fallacy, maup, bimodal patterns??? -->

Traditional models of place-based ecological health typically account for both space and time but do not account for migration between locations. Previous uses of autoregressive models of county-level health include a 2011 paper in which each county's relative position to other counties as well as its historical mortality rates were considered when forecasting future county-level mortality rates[@yang2011]. Another similar paper used an autoregressive model with county-level estimates of mortality that were standardized for measures of income and employment, population density and rurality, and race/ethnicity [@sparks2010]. Similarly, early in the COVID-19 pandemic, researchers used a spatial autoregressive model to assess the relationships between county-level COVID-19 mortality rates and county-level sociodemographic characteristics [@fielding-miller2020]. This method has also been extended to age-group and country-level data to explain cohort effects within countries[@li2017b]. Finally, a 2021 paper adapted this method using age-group data to estimate country-level life expectancy more efficiently, more accurately, and with greater precision for younger populations[@shi2021]. In this paper, we propose a novel extension of traditional spatiotemporal methods that will account for migration in addition to space and time.

<!--# definition of place here -->

### [Data]{.underline}

```{r load data only, echo = FALSE, warning = FALSE, message = FALSE}
load("data_processed/migterm_imp.RData")
```

We use county-level estimates of premature age-adjusted mortality available through CDC WONDER[@cdcwond] joined with IRS county-to-county migration flow data[@soitax].

[The outcome of interest is county-level premature age-adjusted mortality representing the years 2011 through 2019.]{.underline} Premature mortality is defined as any death occurring before age 75. Premature mortality rates are commonly used as a gold standard when comparing various dimensions of health across counties since death has a clear and common definition[@self-rat1997; @olson-williams2023; @jylhä2009]. Additionally, premature age-adjusted mortality has important policy and health equity implications and can be used to assess which individuals or groups are likely to live longest and which individuals or groups may be most in need of additional care. We excluded the year 2020 from our analyses because the onset of the pandemic is unrelated to other factors included in our model.

[The primary explanatory factor of interest is county-level IRS migration flow from 2011 through 2019.]{.underline} In 2011, the IRS changed their methods to produce migration estimates based on a full year of income tax filings rather than a partial year. Prior to 2011, migration estimates represented between 95 and 98 percent of total annual income tax filings and excluded income taxes filed after September of each calendar year[@pierce2015]; estimates after 2011 include all annual income tax filings collected for each year. Therefore, we have chosen only to include data after the 2011 change in IRS methodology. We have chosen to use IRS rather than ACS estimates of migration because ACS does not publish single year estimates of migration (only five year estimates), we want to emphasize the temporal aspects of migration, necessitating the use of IRS single year estimates. <!--# internal migration accounts for what percent of total migration -->

A secondary explanatory factor of interest is urbanicity. To measure urbanicity, we assign each county an urbanicity category based on the 2013 National Center for Health Statistics (NCHS) Urban--Rural Classification Scheme for Counties[@rothwell]. In an effort to improve statistical precision, we grouped these codes into rural and urban. We define rural by grouping the NCHS definitions of micropolitan and noncore such that there are `r length(unique(migterm_imp$destid[migterm_imp$rural == 1]))` counties in our rural dataset. We define urban by grouping the NCHS definitions of large central metro, large fringe metro, medium metro, and small metro such that there are `r length(unique(migterm_imp$destid[migterm_imp$rural == 0]))` counties in our urban dataset.

Since we are particularly interested in spatial trends in premature mortality and migration, we exclude counties from Hawaii and Alaska and include only contiguous counties. <!--# cite others who have excluded HI and AK from their spatial analyses -->Additionally, to avoid systematically excluding counties with small population size and to ensure that we have balanced panel data, we used the mice R package[@buuren2023] to impute premature age-adjusted mortality rates for counties with missing values. There are a total of `r length(unique(migterm_imp$destid))` US counties included in our analyses. <!--# more here about imputations?? and/or justification for imputations? -->

The map below shows the most recent year of premature age-adjusted mortality rates for the counties included in our analyses. This map also highlights the spatial distribution of county-level premature age-adjusted mortality rates across the United States where Southwestern counties tend to have higher rates of premature mortality than counties in the Midwest and Northeast.

```{r prep data for plm, echo = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(splines)
library(splm)

# add geography for use on spatial stuff 
cp = tidycensus::get_acs(geography = "county", year = 2019, variables = c(tpop = "B01003_001"), survey = "acs5", output = "wide", geometry = TRUE)

cpmig = merge(cp, migterm_imp, by.x = "GEOID", by.y = "destid", all.y = TRUE)


# cpmig = cpmig %>% 
#  arrange(year) %>% 
#  group_by(GEOID) %>% 
#  mutate(t = row_number())
# 
# cpmig$ft = as.factor(cpmig$t)

# these are the steps for wrangling all contiguous US states, not just a subset 

cpall = cpmig %>% select(rate_d1, rate_d0, migterm, GEOID, geometry, year)

# commented out because queenw was saved and can now be loaded directly from data_processed 
# spall = cpall %>% select(GEOID, geometry) %>% distinct()
# queen = spdep::poly2nb(spall, row.names = "GEOID", queen = T)
# queenw = spdep::nb2listw(queen, style = "W", zero.policy = TRUE)

cpall = plm::pdata.frame(cpall, index = c("GEOID", "year"))
cpall$ft = as.factor(cpall$year)

# quick n dirty plot of contiguous US to verify that the data contains what it should 
#plot(cpall$geometry)
cp19 = sf::st_as_sf(cpall %>% filter(year == "2019"))

library(tmap)
tm_shape(cp19) + tm_polygons(col = "rate_d1", style = "quantile", n = 10, palette = "Purples", 
                                   title = "Premature Age-adjusted Mortality Rates") + 
  tm_layout(title = "2019 CDC WONDER", frame = FALSE, legend.outside = TRUE) 
```

### [Approach and Results]{.underline}

We test the following four hypotheses:

1.  County-to-county migration patterns improve the explainability of autoregressive models of county-level age-adjusted premature mortality. <!--# 2. The total number of years that a county has had positive net migration or negative net migration improves the explainability of autoregressive models of county-level mortality. -->

2.  County-to-county migration patterns improve the explainability of spatio-temporal autoregressive models of county-level premature age-adjusted mortality.

3.  County-to-county migration patterns improve the explainability of spatio-temporal autoregressive models of county-level premature age-adjusted mortality, even after accounting for rural-urban differences.

4.  Taking into account health-related bias in migration patterns improves our ability to explain county-level premature mortality as well as the differential role that migration plays in urban versus rural counties.

Considering the exploratory nature of these hypotheses, we choose to begin by comparing our *migrational*-temporal autoregressive models with more traditional spatio-temporal models. In traditional spatio-temporal models, place-based determinants of health are regressed against themselves over time as well as against the relative health of their neighbors. Because we hypothesize that spatial correlation may be the result of intra-county migration, we first replace the spatial component of an autoregressive model with a migration component and compare.

Our baseline model is similar to simple autoregressive county-level mortality models used in the past [@yang2012]. In our baseline model, we include yearly mortality rates as a function of time (treated categorically) and premature mortality rates lagged by one year. Random intercepts and slopes in time are included to account for within-county correlation. We included random intercepts for each destination county to account for variation between counties, as recommended by Greenland and Morgenstern's assessment of best practices for ecological studies [@greenland1989]. Splines are used to account for potential nonlinearity in mortality rates. For a given urbanicity subgroup, the baseline model (without splines) is shown below:

$$  y_{it} = \beta_0 + \beta_{1}t_{13i} + \beta_{2}t_{14i} + \beta_{3}t_{15i}  + \beta_{4}t_{16i} + \beta_{5}t_{17i} + \beta_{6}t_{18i} + \beta_{7}t_{19i} + \beta_{8} y_{t-1,i} + \upsilon_{i}t + \mu_{i} + \epsilon_{it}    $$

where\
$y_{it}$ represents the predicted age-adjusted mortality rate of each destination county $i$ at year $t$.\
$t_{yi}$ are binary factor variables for each year of available data.\
$t$ is time, in years, treated continuously.\
$\beta_j$ are unknown regression coefficients.\
$y_{t-1,i}$ is the lagged age-adjusted mortality rate for each destination county $i$ at year $t-1$.\
$\mu_{i}$ is a random intercept for each destination county $i$.\
$\upsilon_{i}$ is a random slope for the effect of time $t$ on each county $i$.\
$\epsilon_{it}$ represents an error term for each destination county $i$ at year $t$.\

<!--# add a factor term for urbanicity; then add interaction between urbancity and lagged y ; eventually need interaction between urb and migterm -->

<!--# this is similar to stratification except t and error are non stratified ; "modifier"; no longer have to worry about contiguous / non contiguous  -->

For **Hypothesis 1**, we compare the baseline model to models that account for migration. To quantify migration, we develop a novel "migration term" which accounts for the mortality rates of individuals who have moved to a county of interest during a given period, essentially a weighted average of the mortality rates of all the origin counties. We calculated the following for each change in year and for each destination county $i$:

$$  mig_{it} = \frac{ \sum_{j\ne i} out_{jit} y_{j,t-1} + y_{i,t-1} (pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} $$

where

$y_{it}$ was defined above\
$out_{ijt}$ represents the number of migrants from a unique origin county $j$ who migrated to a destination county $i$ between year $t-1$ and year $t$.\
$pop_{i, t-1}$ is the population of an unique destination county $i$ at initial year $t-1$\

Below is a table showing median $y_{it}$ as well as median number of in migrants and out migrants by year and by county type for each US county. <!--# probably need to be clearer here that the "rate" is the premature mort rate and not the rate of migration. also maybe should consider switching raw in/out mig vals to be more like   -->

```{r table1 by year, echo = FALSE, warning = FALSE, message = FALSE}

#table1::table1(~totin_d + totout_d + rate_d0 | rural*year, data = migterm_imp)

library(gt)



all = migterm_imp %>% filter(year != 2011) %>% group_by(year) %>% rename(Year = year) %>% select(totin_d, totout_d, rate_d0, rural) %>% 
  summarize(Overall_In = median(totin_d),
               Overall_Out = median(totout_d), 
              Overall_Rate = median(rate_d0), 
               Rural_In = median(totin_d[rural == 1]),
              Rural_Out = median(totout_d[rural == 1]),
                Rural_Rate = median(rate_d0[rural == 1]),
                 Urban_In = median(totin_d[rural == 0]),
              Urban_Out = median(totout_d[rural == 0]),
                Urban_Rate = median(rate_d0[rural == 0]) 
              )

all %>% gt(rowname_col = "year") %>% 
  tab_spanner_delim(
    delim = "_") %>% 
  tab_style(
    style = gt::cell_borders(
      sides = "right",
      weight = px(2)),
    locations = cells_body(columns = c("Year", "Overall_Rate", "Rural_Rate")
    )) %>% 
  tab_caption(caption = "Median number of in migrants, median number of out migrants, and median age-adjusted premature mortality rate by year and county type")
    




# plotdat = migterm_imp %>% group_by(rural, year) %>% 
#   mutate(medianrate = median(rate_d1),
#          medianmig = median(migterm),
#          rural = as.factor(rural)) %>% 
#   select("year", "medianmig", "medianrate", "rural") %>% 
#   pivot_longer(-c(year,rural), names_to = "var", values_to = "value")
# 
# ggplot(data = plotdat, aes(x = year, y = value, group = interaction(rural, var), color = as.factor(var), shape = rural)) + geom_line() + geom_point() + 
#   labs(color = "", shape = "") + xlab("") + ylab("Age-adjusted premature deaths per 100,000 population") + 
#   scale_color_manual(labels = c("Median weighted average migration term", "Median age-adjusted premature mortality rate"), values = c("darkblue", "darkred")) + 
#   scale_shape_manual(labels = c("Urban", "Rural"), values = c(1, 0)) +
#   theme_minimal()
```

Our weighted-average approach implicitly accounts for between-county selection for migration, but does not account for within-county selection of migrants. In other words, our best guess for the mortality rate of migrants is exactly the mortality rate of their original county; meanwhile, some counties are more likely to be destinations for migration than others.

Because we know county-level health to be related to county-level natality, and because our outcome variable (premature age-adjusted mortality) may not capture the health of young people in counties, we first conducted a sensitivity analysis of the effect of natality on the effect of our migration term. We determined that natality does not change the effect or explainability of the migration term and therefore does not need to be included in our models. <!--# more here??? -->

We analyzed several models and used the Bayesian Information Criterion (BIC) to determine the best fitting model. BIC is commonly used to determine models with greatest explanatory power [@kuha2004]. Starting with our baseline model, we iteratively added splines for the prior year's average county-level premature mortality rate and the migration term, capturing potential nonlinear trends. We chose to keep the number of degrees of freedom equal for splines for the migration term and premature mortality rate since we noticed that imbalanced degrees of freedom tended to produce higher BIC scores. Models that included the migration term had consistently lower BIC scores than models that did not include the migration term. All models were created using the splm and and splines R packages [@splines][@millo2023].

**To test Hypothesis 2**, we built models that accounted for spatial error as well as migration again using the splm and splines packages in R[@millo2023]. We again compared these models using BIC while iteratively adding splines with equal degrees of freedom for migration and lagged premature mortality. Again, models that included the migration term had consistently lower BIC scores than models that did not include the migration term. Therefore, even after accounting for spatial error, the migration term remained important to explaining county-level premature age-adjusted mortality rates. The table below shows the model with the lowest BIC score (and largest change in BIC relative to the reference) in green.

```{r nonspatial models here, echo = FALSE, warning = FALSE, message = FALSE}

#BIC scores were generated in "spatial mod selection.R"  
load("temporary output/bicnospat.Rdata")

ref = bicnospat[names(bicnospat) == "fnom"]
bicnospat = round(bicnospat - ref, 2)


load("temporary output/bicspat.Rdata")

bicspat = round(bicspat - ref, 2)

tablex = data.frame("Migration term included" = c(rep(TRUE, 5), rep(FALSE, 5), rep(TRUE, 5), rep(FALSE, 5)), 
                    "Accounting for spatial error" = c(rep(TRUE, 10), rep(FALSE, 10)), 
                    "Degrees of freedom" = rep(c(1,2,3,4,5), 4),
                    "BIC" = c(bicspat[1], bicspat[3], bicspat[5], bicspat[7], bicspat[9],
                              bicspat[2], bicspat[4], bicspat[6], bicspat[8], bicspat[10],
                    bicnospat[1], bicnospat[3], bicnospat[5], bicnospat[7], bicnospat[9],
                              "REFERENCE", bicnospat[4], bicnospat[6], bicnospat[8], bicnospat[10]))


library(gt)
gt::gt(tablex) |> tab_style(style = list(cell_fill(color = "palegreen3"), 
                                      cell_text(weight = "bold")),
                            locations = cells_body(rows = (BIC == min(as.numeric(BIC), na.rm = TRUE)))) |>
  tab_style(style = list(cell_fill(color = "lightgrey"),
                         cell_text(weight = "bold")),
                         locations = cells_body(rows = (BIC == "REFERENCE"))) |>
  cols_label(Migration.term.included = "Migration included", 
             Accounting.for.spatial.error = "Adjusted for spatial error", Degrees.of.freedom="DF", BIC= "BIC") |>
  tab_header(title = "Change in BIC relative to reference")




```

**To test Hypothesis 3**, we added a factor term for urbanicity including interaction terms between urbanicity and $y_{i,t-1}$ and urbanicity and $mig_{i,t}$ to the models accounting for spatial error used to test Hypothesis 2. We again compared these models using BIC while iteratively adding splines with equal degrees of freedom for migration and lagged premature mortality.

In order to maximize the number of counties per category, we chose to use only two urbanization categorizations: urban and rural, where urban includes large central metro, medium metro, and small metro counties <!--# i verified this using cococino county as a check - these definitions are also outlined and cited in the data section --> and rural includes micropolitan and noncore counties. We assessed `r length(unique(migterm_imp$destid[migterm_imp$rural == 1]))` unique rural counties and `r length(unique(migterm_imp$destid[migterm_imp$rural == 0]))` unique urban counties. Again, we utilized the same steps outlined above to determine which model had the most explanatory power and lowest BIC score. We found that trends in premature mortality rates while accounting for urbanicity could be explained by the same model as the one used previously. Once again, even after accounting for spatial error, the migration term remained important to explaining county-level premature age-adjusted mortality rates even after accounting for urbanicity.

<!--# need to update this table and/or decide no table for this section-->

```{r urban rural mod selection, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}
#BIC scores were generated in "spatial mod selection.R"  
load("temporary output/bicspat_rural.Rdata")
load("temporary output/bicspat_urb.Rdata")

ref_rural = bicspat_rural[names(bicspat_rural) == "fnom"]
ref_urb = bicspat_urb[names(bicspat_urb) == "fnom"]
bicspat_rural = round(bicspat_rural - ref_rural,2)
bicspat_urb = round(bicspat_urb - ref_urb, 2) 

tablex_urb = data.frame("Migration term included" = c(rep(TRUE, 5), rep(FALSE, 5)), 
                    "Degrees of freedom" = rep(c(1,2,3,4,5), 2),
                    "Urban BIC" = c(bicspat_urb[1], bicspat_urb[3], bicspat_urb[5], bicspat_urb[7], bicspat_urb[9],
                             "REFERENCE", bicspat_urb[4], bicspat_urb[6], bicspat_urb[8], bicspat_urb[10]))
tablex_rural = data.frame("Migration term included" = c(rep(TRUE, 5), rep(FALSE, 5)), 
                    "Degrees of freedom" = rep(c(1,2,3,4,5), 2),
                    "Rural BIC" = c(bicspat_rural[1], bicspat_rural[3], bicspat_rural[5], bicspat_rural[7], bicspat_rural[9],
                              "REFERENCE", bicspat_rural[4], bicspat_rural[6], bicspat_rural[8], bicspat_rural[10]))
tablex = cbind(tablex_urb, Rural.BIC = tablex_rural$Rural.BIC)

library(gt)
gt::gt(tablex) |> tab_style(style = list(cell_fill(color = "palegreen3"), #green because urb and rural are the same 
                                      cell_text(weight = "bold")),
                            locations = cells_body(rows = (Rural.BIC == min(as.numeric(Rural.BIC), na.rm = TRUE)))) |>
  tab_style(style = list(cell_fill(color = "palegreen3"), 
                                      cell_text(weight = "bold")),
                            locations = cells_body(rows = (Urban.BIC == min(as.numeric(Urban.BIC), na.rm = TRUE)))) |>
  tab_style(style = list(cell_fill(color = "lightgrey"),
                         cell_text(weight = "bold")),
                         locations = cells_body(rows = (Rural.BIC == "REFERENCE"))) |>
  cols_label(Migration.term.included = "Migration included", Degrees.of.freedom="DF", Rural.BIC = "Rural BIC", Urban.BIC = "Urban BIC") |>
  tab_header(title = "Models accounting for spatial error")
```

Finally **to test Hypothesis 4**, we added parameters $k_{ij}$ and $l_i$ to the premature mortality rate of each origin $j$ and each destination $i$ within our equation for the migration term. We call this new, simulated migration term $smig_{it}$. The equation for $smig_{it}$ is shown below. We use $smig_{it}$ to simulate within-county selection for migration: when the parameter $k_{ij}$ is subtracted (ie decreased mortality rate), we simulate migration by individuals who are healthier than the average of their origin $j$. When the parameter $k_{ij}$ is added (ie increased mortality rate), we simulate migration by individuals who are unhealthier than the average of their origin $j$. Likewise, when the parameter $l_i$ is subtracted (ie decreased mortality rate), we simulate migration by individuals who are healthier than the average of their destination $i$. When the parameter $l_i$ is added (ie increased mortality rate), we simulate migration by individuals who are unhealthier than the average of their origin $i$. We specify that $k_{ij}$ depends on both origin $j$ and destination $i$ since health related selection for migration is connected to both the origins and the destinations of counties; meanwhile $l_i$ is dependent only upon the health of destination $i$.

$$  smig_{it}(k_{ij}, l_i) = \frac{ \sum_{j\ne i} out_{jit} ( y_{j,t-1} + k_{ij}) + (y_{i,t-1} + l_i) (pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} $$

Since we are most interested in how the values of $k_{ij}$ and $l_i$ are related to each other, we chose to simplify $smig_{it}$ such that $l_i$ is held constant and only $k_{ij}$ fluctuates. Therefore, if we assign $d_{ij}$ to be the difference between $k_{ij}$ and $l_i$ we can create a new equation for $k_{ij}$ in terms of $l_i$ and $d_{ij}$ such that $k_{ij} = l_i+ d_{ij}$. Then our equation for $smig_{it}(k_{ij})$ becomes:

$$  smig_{it}(l_i+d_{ij}, l_i) = \frac{ \sum_{j\ne i} out_{jit} ( y_{j,t-1} + l_i + d_{ij}) + (y_{i,t-1} +l_i)( pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} $$

which can be simplified into the following:

$$  smig_{it}(d_{ij}) = \frac{ \sum_{j\ne i} out_{jit} ( y_{j,t-1} + d_{ij}) + y_{i,t-1} (pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} +l_i$$

<!--# li gets accounted for in the random intercept since it is a constant  -->

<!--# we need different values of dij for rural to rural, rural to urban, etc  -->

<!--# add column for d; make d depend on urb, rural  -->

<!--# dij = a + bi + cj + fij  -->

Therefore, using the equation above, we simulate health-related selection occurring as a result of the differences in health between the origin and the destination counties.

To determine which values of $d_{ij}$ best explain trends in county-level premature mortality rates, we replace $mig_{it}$ with $smig_{it}(d_{ij})$ in the model found for Hypotheses 2 and 3 (a spatial error model with splines with 4 degrees of freedom each for lagged premature age-adjusted mortality and migration). We then test potential values of $d_{ij}$ to determine which value produces the lowest BIC score. To understand this phenomenon further, we tested potential values of $d_{ij}$ when accounting for urbanicity such that potential values of $d_{ij}$ were dependent upon whether origins and destinations were rural or urban. The model with the lowest BIC score occurred when there was no difference in the average health of a rural destination county and a rural origin county, no difference in the average health of an urban destination county and an urban origin county, and slightly worse health among migrants from urban origins to rural destinations and migrants from rural origins to urban destinations. Interestingly, this suggests that when moving from counties that are similar, health-related selection is not at play. But when moving from counties that differ in urbanicity, less healthy people are selected to migrate. This is somewhat counter to what the literature says about health and migration. Typically migrants are healthier on average than the general population. But it is important to consider *relative* to whom. In our models, we have found that migrants with rural destinations tend to be slightly less healthy than others within their urban origin counties - this could indicate that older (less healthy) individuals tend to move to rural places from urban places. Meanwhile, we found that migrants with urban destinations tend to be slightly less healthy than others within their rural origin counties - this could indicate that people migrate to cities seeking resources which could be tied to health CITE. Interestingly, when we isolate the effects of rural-urban migration and urban-rural migration on BIC score separately, we see that trends in BIC score are primarily driven by rural-urban migration; there does not appear to be a strong relationship between BIC score and the difference in premature mortality rate of urban origin and rural destination counties, but there does appear to be a strong relationship between BIC score and the difference in premature mortality rate of rural origin and urban destination counties.

```{r}
load("C:/Users/holsonwillia/Documents/fromchtc/chtctot.RData")
load("C:/Users/holsonwillia/Documents/fromchtc/chtctot25.RData")



chall = rbind(chtctot, chtctot25)

#minimum BIC 
#chall[chall$bicspat == min(as.numeric(chall$bicspat), na.rm=TRUE),]


bicmin = chall %>% filter(kuu == 0 & krr == 0)
#lattice::wireframe(bicspat ~ as.numeric(kru) * as.numeric(kur) , data = bicmin)
ggplot(aes(x = as.numeric(kur), y = as.numeric(bicspat)), data = bicmin) + 
  geom_point() + 
  xlab("Difference in average premature mortality rate\n between urban origin counties and rural destination counties") +
  ylab("BIC") + 
  theme_bw() +
  labs(subtitle = expression(paste("Relationship between BIC and ", d[ij], "\n (assuming that ", d[rr], " = 0, and ", d[uu], " = 0)")),
       title = "Urban-Rural Migration")


ggplot(aes(x = as.numeric(kru), y = as.numeric(bicspat)), data = bicmin) + 
  geom_point() + 
  xlab("Difference in average premature mortality rate\n between rural origin counties and urban destination counties") +
  ylab("BIC") + 
  theme_bw() +
  labs(subtitle = expression(paste("Relationship between BIC and ", d[ij], "\n (assuming that ", d[rr], " = 0, and ", d[uu], " = 0)")),
       title = "Rural-Urban Migration")

```

### [**Conclusions**]{.underline}

To justify further investigation, first we determined that our migration term added explainability (as measured by low BIC score) to our most basic autoregressive model. The best fitting model in terms of BIC score included splines with four degrees of freedom for both the autoregressive term and our weighted average migration term. Thus, models that account for migration had more explanatory power than models that included only the prior year's average county-level mortality rate. **This confirms Hypothesis 1.**

For a more robust comparison, we then accounted for spatial error. Again, we found that the best fitting model in terms of BIC score included splines with four degrees of freedom for both the autoregressive term and our weighted average migration term. Additionally, we determined that models that accounted for both spatial error and migration had lower BIC scores than models that did not account for spatial error or did not include our migration term. **This confirms Hypothesis 2.**

Then, to quantify potential rural-urban differences in the role of intercounty migration on county-level health, we used spatial error models to assess the effect of migration on premature age-adjusted mortality with an interaction term for urbanicity. We found that after adjusting for urbanicity, the models with the lowest BIC scores included splines with four degrees of freedom each for the migration term and lagged age-adjusted mortality as well as the net migration term factor variable. Thus, even after accounting for urbanicity, the migration term added explainability to our models.

Finally, we simulated health-related selection for migration using $d_{ij}$, the difference on average of health in a destination county and health in an origin county, and concluded that, based on our models, trends in model explainability are primarily driven by rural-urban migration, with people leaving rural counties to go to urban destinations being slightly less healthy on average than the health of their rural origins on average. Therefore, we have **partially confirmed Hypothesis 4**: health-related selection for migration improves our ability to explain county-level premature mortality to urban counties from rural counties, but we cannot form strong conclusions about health-related selection to rural destinations.

<!--# need to confirm no interactions between netmig, migterm, and autoreg -->

### Discussion and Limitations {.underline}

We consider several pitfalls and alternatives. First, because our migration term is essentially a weighted average of the mortality rates of origin counties, the migration term and lagged mortality rates are highly correlated, resulting in multicollinearity. As a result, we cannot easily interpret the effect of the migration term itself, other than knowing that its inclusion results in a model with more explanatory power over all. Application of results must consider this shortcoming.

Second, we selected our outcome of interest, county-level premature age-adjusted mortality, because it is comparable across years and locations and because it is consistently and robustly defined. However, in 2019, the median age of all movers across the US was under 30 years old [@s0701:g] - therefore, even when accounting for premature mortality (deaths occurring in individuals under age 75), the population that is migrating is not necessarily the same population that is dying. Subsequently, trends in county-level premature mortality might be better explained by trends in county-level migration twenty to fifty years earlier. That said, county-level measures of premature mortality are commonly used as a proxy for county overall health. For instance, a 1983 report by the WHO recommending measures in mortality and morbidity to understand the relationship between health and migration [@gushulak2006], and measures of length of life are allocated 50% weight in the County Health Rankings Model of place-based health outcomes [@explore]. Ideally we would use a more precise age-group-specific measure of mortality paired with an age-group-specific measure of migration; however, this would require a migration data source other than the IRS migration flow data which we use here and therefore could not include analysis of the entire United States. Additionally, ideally, we would confirm our findings by assessing the health of migrants themselves. This task would require individual longitudinal data. This is not currently within the scope of this project.

One final limitation of IRS data (which we are attempting to leverage as a strength in our analyses) is that households that do not file tax returns cannot be included in migration estimates. Therefore, many university students, low-income households, and workers who receive informal wages are systematically missing from IRS migration estimates[@dewaard2022]. These individuals may be more likely to be included in ACS and Census estimates [@bureau] though no population estimate is perfect. Because IRS county-to-county migration data includes only individuals who file taxes with the US government both before and after they migrate, we assume that individuals represented in the IRS migration flows data are less likely to be pushed to migrate by potentially health-related factors such as violence, famine, and corruption than individuals who migrate but are excluded from the IRS data. Therefore, any differences in changes in health between counties may be the result of self-selection by IRS-represented migrants or health-related selection by nonIRS-represented migrants. Despite these limitations, IRS migration data has been used many times in the past to complete complex and accurate analyses of US migration patterns. For instance, IRS migration flow data has been used to estimate the effects of sea-level rise on geographic distribution of the US population[@hauer2017], measure recovery after Hurricanes Katrina and Rita[@curtis2015], and assess the economic impacts of migration resulting from environmental hazards [@shumway2014].

There are many factors that contribute to the health of a place. In our analyses, we have chosen to emphasize the potential impact of migration or movement between places on place-based health. We accounted for intercounty selection for migration (ie some counties are more likely to experience migration than others) using our weighted average migration term and intracounty selection for migration (ie some individuals are more likely to migrate than others) using our $k_i$ and $k_j$ simulation. Future research should investigate a potential relationship between $k_i$ and $k_j$ - perhaps some destinations are more likely to attract migrants of relative health than others.

We cannot fully understand county-level health without first understanding county interconnectedness and how it drives place-based health disparities. Recognizing that the United States is heterogeneous and that the mechanisms by which migration may impact health may also be heterogeneous, we attempt to quantify rural-urban differences in the relationship between migration and place-based health. The long-term goal of this work is to contribute to understanding the mechanisms by which mobility may be related to place-based health disparities so that local decision-makers may account for patterns in mobility when creating policy towards improved health for all people in all places. Understanding rural-urban mobility patterns is a necessary first step towards understanding rural-urban health disparities.

<!--# code for visuals not currently in use -->

## scratch

```{r urb rural comparison plot, include = FALSE, echo = FALSE, warning = FALSE, include = FALSE}
# not sure how to visualize this……… the plot below does not seem effective 

# # add geography for use on spatial stuff
# cp = tidycensus::get_acs(geography = "county", year = 2019, variables = c(tpop = "B01003_001"), survey = "acs5", output = "wide", geometry = TRUE)
# 
# 
# load("data_processed/imputed_for_ksim.Rdata") 
# #this dataset is called natmorturb_imp
# # it has natality, death, population, premature mortality rates, migration flows, rural/urb codes but no migterms (yet)
# # it is balanced and has no missing rates (except for initial years)
# 
# #this formula produced lowest bic for spatial and non spatial models as shown in "spatial mod selection.R"
# fff4 = rate_d1 ~ ft + ns(rate_d0, df = 4) + ns(migterm, df = 4) # + (1 + t | GEOID) 
# 
# #load spatial weights matrices created previously 
# load("data_processed/queenruralw.Rdata")
# load("data_processed/queenurbw.Rdata")
# 
# 
# ksi_urb = 0
# ksj_urb = 0
# ksi_rural = -300
# ksj_rural = -300
# 
# 
# 
# tempdf_rural = natmorturb_imp %>% filter(rural == 1) %>% 
#   group_by(destid, year) %>% 
#       mutate(migterm = (sum(out_o *(rate_o0 + ksi_rural), na.rm = TRUE) + (rate_d0 + ksj_rural) * (as.numeric(pop_d0)-as.numeric(totout_d)))/(sum(out_o, na.rm = TRUE) + (as.numeric(pop_d0)- totout_d))) %>% 
#       distinct(destid, migterm, year, rate_d0, rate_d1, .keep_all = TRUE)
#     
# cpij_rural = merge(cp, tempdf_rural, by.x = "GEOID", by.y = "destid", all.y = TRUE)
#     
# cpij_rural = plm::pdata.frame(cpij_rural, index = c("GEOID", "year"))
# cpij_rural$ft = as.factor(cpij_rural$year)
#     
#       
# #this is the best spatial model as determined during hypothesis 3 
# spat_fff4_rural = splm::spml(formula = fff4, data =cpij_rural, model = "random", listw = queenruralw, lag = FALSE, spatial.error= "b", local = list(parallel = TRUE))
#              
# 
# 
# 
# tempdf_urb = natmorturb_imp %>% filter(rural == 0) %>% 
#   group_by(destid, year) %>% 
#       mutate(migterm = (sum(out_o *(rate_o0 + ksi_urb), na.rm = TRUE) + (rate_d0 + ksj_urb) * (as.numeric(pop_d0)-as.numeric(totout_d)))/(sum(out_o, na.rm = TRUE) + (as.numeric(pop_d0)- totout_d))) %>% 
#       distinct(destid, migterm, year, rate_d0, rate_d1, .keep_all = TRUE)
#     
# cpij_urb = merge(cp, tempdf_urb, by.x = "GEOID", by.y = "destid", all.y = TRUE)
#     
# cpij_urb = plm::pdata.frame(cpij_urb, index = c("GEOID", "year"))
# cpij_urb$ft = as.factor(cpij_urb$year)
#     
#       
# #this is the best spatial model as determined during hypothesis 3 
# spat_fff4_urb = splm::spml(formula = fff4, data =cpij_urb, model = "random", listw = queenurbw, lag = FALSE, spatial.error= "b", local = list(parallel = TRUE))
#              
# 
# #plotting fitted vals instead of predicted vals….
# 
# fiturb = fitted(spat_fff4_urb)
# 
# ploturb = data.frame()
# for (i in 1: (length(fiturb)/length(unique(cpij_urb$GEOID)))){
#   temp = data.frame(fitted = mean(fiturb[i:(i*length(unique(cpij_urb$GEOID)))], na.rm = TRUE), year = i + 2011)
#   ploturb = rbind(ploturb, temp)
# }
# 
# ploturb$group = "Urban"
# 
# fitrural = fitted(spat_fff4_rural)
# 
# plotrural = data.frame()
# for (i in 1: (length(fitrural)/length(unique(cpij_rural$GEOID)))){
#   temp = data.frame(fitted = mean(fitrural[i:(i*length(unique(cpij_rural$GEOID)))], na.rm = TRUE), year = i + 2011)
#   plotrural = rbind(plotrural, temp)
# }
# plotrural$group = "Rural"
# 
# plotdata = rbind(ploturb, plotrural)
# 
# #there doesn't appear to be a built in function for getting the predicted values from a spml model……. 
# # https://r-spatial.github.io/spatialreg/reference/predict.sarlm.html
# # "for the error model, trend = xbeta and signal = lambda W y - lambda W xbeta - maybe this is the key to calcing our own??? 
# # preddata_rural = spatialreg::predict.Sarlm(spat_fff4_rural, cpij_rural)
# # pd_rural = data.frame(cbind(x =  cpij_rural$rate_d0, y = preddata_rural))
# # pd_rural$group = "Rural"
# #  
# # preddata_urb = predict(spat_fff4_urb, cpij_urb)
# # pd_urb = data.frame(cbind(x =  cpij_urb$rate_d0, y = preddata_urb))
# # pd_urb$group = "Urban" 
# # 
# # plotdata = rbind(pd_rural, pd_urb)
# 
# 
# ggplot(plotdata, aes(x= year, y = fitted, group = group, color = group, shape = group)) + 
#   geom_line() 
#   xlab("Potential initial premature mortality rate") +
#   ylab("Predicted premature mortality rate") +
#   theme_bw() +
#   geom_abline(slope = 1) +
#   #annotate("text", x = 680, y = 660, angle = 45, label = "Reference y = x") +
#   tune::coord_obs_pred() 
# 
```

```{r migterm URBAN AND RURAL PLOTS zoomed, include = FALSE, message = FALSE, warning = FALSE}
   
# 
# tempdf_urban = urban_mnn[c(rep(1,14)),]
# 
# tempdf_rural = rural_mnn[c(rep(1,14)),] #dummy data - first 14 rows of original dataframe 
# 
# tempdf_urban$rate_d0 = c(seq(250, 575, by = 25)) #replace with old mortality rates 
# #tempdf$ft = as.factor(c(1:14)) #unnecessary bc we only intend to compare two years and it doesn't matter which two 
# tempdf_rural$rate_d0 =  c(seq(250, 575, by = 25))
# 
# df_rural= rbind(tempdf_rural, tempdf_rural, tempdf_rural, tempdf_rural, tempdf_rural, tempdf_rural) #need to do it this way bc rep causmiges errors 
# df_urban= rbind(tempdf_urban, tempdf_urban, tempdf_urban, tempdf_urban, tempdf_urban, tempdf_urban)
# 
# 
# #df_forpred = rbind(df_rural, df_urban) 
# 
# df_rural$migterm = c(df_rural$rate_d0[1:28] - 10, 
#                       df_rural$rate_d0[29:56] + 10, 
#                       df_rural$rate_d0[57:84])
# df_urban$migterm = c(df_urban$rate_d0[1:28] - 10, 
#                       df_urban$rate_d0[29:56] + 10, 
#                       df_urban$rate_d0[57:84]) #vary the migterm based on mortrate by 10
# 
# 
# 
# df_urban$group = c(rep(-10, 28), rep(10, 28), rep(0, 28))
# df_rural$group = c(rep(-10, 28), rep(10, 28), rep(0, 28))
# 
# 
# plotdata_rural = data.frame()
# plotdata_urban = data.frame()
# #for each variant of migterm, create a predicted value 
# 
# for (i in 1:3) {
#   gi = unique(df_rural$group)[i]
#   preddata = predict(rurmod, df_rural[df_rural$group == gi,])
#   pd = data.frame(cbind(x =  seq(250, 575, by = 25), y = preddata))
#   pd$group = gi
#   plotdata_rural = rbind(plotdata_rural, pd)
# } 
# 
# for (i in 1:3) {
#   gi = unique(df_urban$group)[i]
#   preddata = predict(urbmod, df_urban[df_urban$group == gi,])
#   pd = data.frame(cbind(x =  seq(250, 575, by = 25), y = preddata))
#   pd$group = gi
#   plotdata_urban = rbind(plotdata_urban, pd)
# } 
# 
# plotdata_urban$type = "Urban" 
# plotdata_rural$type = "Rural"
# 
# plotdata = rbind(plotdata_urban, plotdata_rural)
# plotdata$gg = paste0(plotdata$group, plotdata$type)
# 
# 
# 
# migtermplot = ggplot(plotdata, aes(x= x, y = y, group = gg, color = as.factor(group), shape = as.factor(type), alpha = as.factor(type), size = as.factor(type))) + geom_point(alpha = as.factor(plotdata$type)) + 
#   geom_line()+
#   scale_color_manual(name = "Difference between migration term\n and initial premature mortality rate", values = scales::brewer_pal("qual")(3))+
#   xlab("Potential initial premature mortality rate") + 
#   ylab("Predicted premature mortality rate") + 
#   theme_bw() +
#   geom_abline(slope = 1) + 
#   #annotate("text", x = 680, y = 660, angle = 45, label = "Reference y = x") +  
#   tune::coord_obs_pred() + 
#   labs(color = "", title = "Relationship between migration term and predicted premature mortality \namong rural and urban counties", shape = "Rural or urban", size = "Rural or urban", alpha = "Rural or urban") + 
#   scale_alpha_discrete(range = c(0.2, 1)) +
#   scale_size_discrete(range = c(0.8, 1.5)) 
# 
# migtermplot

# ggsave(plot = migtermplot, filename = "migtermplot.png", width = 3500, height = 2600, device = "tiff", dpi = 500, unit = "px")

#note that i saved this directly from the plot viewer rather than mess around with save dimensions / file types….. this does add an extra step tho if this plot ever needs to be changed….. 

#for covid removal... 
#  across the US, the median age-adjusted county-level premature mortality rate rose from `r nocovid$medprem[nocovid$Year == "2019"][1]` per 100,000 in 2019 to `r nocovid$medprem[nocovid$Year == "2020"][1]` per 100,000 in 2020. This unprecedented change in premature mortality is difficult to model since (commented out because the change for prmeature mort is not all that large
```

make a table where rows = years three vars: premature mortality, in migration, out migration all at the county level do this for overall, rural, urban

clean up map

add bic table where the kjs are constant for overall, not just rural/urb

make tables have a reference BIC and then change against reference instead of just raw BIC make tables wider whenever possible. make BIC with no mig and 1 df the reference value

for the line plot, make ki = 0 the reference value and then make the y axis the relative change. maybe need to have two y axes

, with the best fitting model for rural counties highlighted in blue, the best fitting model for urban counties highlighted in red, and the best model for rural and urban counties combined highlighted in green.

```{r ksim all combined, echo = FALSE, messgage = FALSE, warning = FALSE} load("data_processed/ksim_bic_kikjdiff_iconstant.Rdata") iconst_min = bickij  load("data_processed/ksim_bic_kikjdiff_iconstantMAX.Rdata") bickijall = rbind(bickij, iconst_min) %>% distinct()  refbick =bickijall[bickijall$ksj == max(bickijall$ksj),]$bicspat  bickijall$bicspat = round(bickijall$bicspat - as.numeric(refbick),2) #bickijall$bicspat[bickijall$bicspat == 0] = "REFERENCE"   ksim_bic_all = bickijall %>% select(ksi, ksj, bicspat) %>% arrange(ksj) %>% filter(ksj>=-80)  ggplot(bickijall, aes(x = ksj, y = as.numeric(bicspat))) + geom_point()    #BIC scores were generated in "ksim mod selection with urb.R"   load("data_processed/ksim_bic_rural_kikjdiff_iconstant.Rdata") load("data_processed/ksim_bic_urb_kikjdiff_iconstant.Rdata")  ksim_rural = bickij_rural %>% select(ksi, ksj, bicspat) %>%    mutate("BIC rural" = round(bicspat - bicspat[ksj == 0],2))  ksim_rural$`BIC rural`[ksim_rural$`BIC rural` == 0] = "REFERENCE"  ksim_urb = bickij_urb %>% select(ksi, ksj, bicspat) %>%    mutate("BIC urban" = round(bicspat - bicspat[ksj == 0],2))  ksim_urb$`BIC urban`[ksim_urb$`BIC urban` == 0] = "REFERENCE"     ksim_urbrur = cbind(ksim_rural, "BIC urban" = ksim_urb$`BIC urban`) %>% select(-c(bicspat))  ksim_allthree = cbind(ksim_urbrur, "BIC all counties" = ksim_bic_all$bicspat) %>% select(-c(ksi))   gt::gt(ksim_allthree) |> tab_style(style = list(cell_fill(color = "palegreen3"),                                        cell_text(weight = "bold")),                             locations = cells_body(rows = (`BIC all counties` == min(as.numeric(`BIC all counties`), na.rm = TRUE)))) |>     tab_style(style = list(cell_fill(color = "lightsteelblue"),                                        cell_text(weight = "bold")),                             locations = cells_body(rows = (`BIC rural` == min(as.numeric(`BIC rural`), na.rm = TRUE)))) |>   tab_style(style = list(cell_fill(color = "lightsalmon"),                                        cell_text(weight = "bold")),                             locations = cells_body(rows = (`BIC urban` == min(as.numeric(`BIC urban`), na.rm = TRUE)))) |>     tab_style(style = list(cell_fill(color = "lightgrey"),                           cell_text(weight = "bold")),                           locations = cells_body(rows = (`BIC all counties` == "REFERENCE"))) |>   cols_label(ksj = "k_j") |>   tab_header(title = "Models simulating migration selection")}
```

A negative value of $k_j$ indicates that migrants were healthier (ie lower premature mortality rate) than the average of their origin counties. A value of 0 for $k_j$ indicates that the model with the most explanatory power is one where migrants have the same health on average as the health of their origins. In other words, our models show that people who *leave* a place to migrate elsewhere have health that is approximately the same as the average health of the place they are leaving; meanwhile people who *enter* a place have health that is slightly better than the average health of the place they are entering.

```{r, echo = FALSE, message = FALSE, warning = FALSE}
plotdat = ksim_urbrur %>% 
  pivot_longer(cols = c(`BIC rural`, `BIC urban`), names_to = "BIC")

plotdat$type = ifelse(plotdat$BIC == "BIC rural", "Rural", "Urban") 

mycolors = c("Rural" = "lightsteelblue", "Urban" = "lightsalmon") 

plotdat$value[plotdat$value == "REFERENCE"] = 0   

ggplot(plotdat) + geom_line(aes(x = ksj, y = as.numeric(value), group = type, color = type)) +    xlab("k_j") +    scale_y_continuous(name = "Change in BIC relative to reference") +   scale_color_manual(name = "", values = mycolors) + theme_bw()
```

As indicated by the plot above, migrants to rural counties are more likely to be healthier on average (ie negative $k_i$)than their origin counties. Models for rural counties also appear to be more sensitive to the health-related selection of migrants than urban counties, as indicated by the sharp swing of the Rural curve above. This is likely because rural counties have smaller population sizes. On the other hand, the best fitting models for urban counties indicate that migrants to urban counties tend to be less healthy on average than their origins (ie positive $k_i$).
