---
title: "Accounting for migration in spatiotemporal models of county-level health"
date: ""
author: "Hannah Olson-Williams, Amy Cochran"
format: 
  docx:
    execute:
      echo: false
      warning: false
      error: false
      message: false
editor: visual
#bibliography: references.bib
---

<!--# perhaps should add: -->

<!--# some explanation of spatial error versus spatial lag -->

<!--# packages used to assess each aim -->

<!--#  need sensitivity analysis with natality before adding urb; so basically 1) add mig; 2) add natality; 3) decide about natality; 3) add urb  -->

### ~~Methods~~ 

<!--# hypotheses should be at end of intro instead -->~~We test the following hypotheses:~~

1.  ~~County-to-county migration flows improve the explainability of spatiotemporal models of county-level health outcomes.~~

2.  ~~County-to-county migration flows improve the explainability of spatiotemporal models of county-level health outcomes, even after accounting for rurality.~~

3.  ~~Taking into account unmeasured factors in county-to-county migration flows improves our ability to explain county-level health outcomes as well as the differential role that migration plays in urban versus rural counties.~~

<!--# need data section here and then variables section (move migterm here) (table 1 still does not go here!!)  -->

<!--# need selection bias (dij) defined in variable section too  -->

## ~~Modeling~~ 

~~Baseline Model~~

~~We first establish a baseline model which is similar to autoregressive spatial error models of county-level mortality used in the past [@yang2012]. This baseline model includes yearly mortality rates as a function of time (treated categorically) and premature mortality rates lagged by one year. Random intercepts for each destination county are included to account for variation between counties, following best practices for ecological studies[@greenland1989]. We tested splines with two to five degrees of freedom to account for potential nonlinearity in mortality rates. The baseline spatial error model (without splines) is shown below:\
~~

$$  y_{it} = \beta_0 + \beta_{1t} + \beta_{2}y_{t-1,i} + \mu_{i} + \epsilon_{it}    $$

~~where~~ <!--# want thsi in paragraph form instead of in a list; need to change definition of b1t to match eq above  -->~~\
~~$y_{it}$ ~~represents the predicted age-adjusted mortality rate of each destination county~~ $i$ ~~at year~~ $t$~~.\
~~$ft_{k}$ ~~are binary factor variables for each year~~ $k$ ~~of available data (2012 through 2019) where~~ $K$ ~~is the number of years (8 total), such that~~ $\beta_{1k}$ ~~represents the effect of the~~ $k$~~th year on~~ $y_{it}$~~\
~~$t$ ~~is time, in years, treated continuously.\
~~$y_{t-1,i}$ ~~is the lagged age-adjusted mortality rate for each destination county~~ $i$ ~~at year~~ $t-1$~~.\
~~$\mu_{i}$ ~~is a random intercept for each destination county~~ $i$~~.\
~~$\epsilon_{it}$ ~~represents an error term accounting for spatial dependencies such that:~~

$$
\epsilon_{it} = \lambda W \epsilon_{it} + u_{it}  
$$

~~where~~

$\epsilon_{it}$ ~~is the random error term for each county~~ $i$ ~~at year~~ $t$

$\lambda$ ~~is the spatial autoregressive parameter~~ <!--# describe interpretation here ; 0 lambda = no interdependence; large lambda lots of interdependence -->

$W$ ~~is the spatial weights matrix~~ <!--# more detail here ; what kind of weights; how big is this matrix, etc -->

$u_{it}$ ~~is the spatially independent error term for each county~~ $i$ ~~at year~~ $t$<!--# need more context here -->

To determine whether county-to-county migration flows improve the explainability of spatiotemporal models of county-level health outcomes (Hypothesis 1), we compared the baseline model to models that account for migration. To quantify migration, we developed a novel "migration term" which accounts for the mortality rates of individuals who have moved to a county of interest during a given period. This term is essentially a weighted average of the mortality rates of all the origin counties. We calculated the following for each change in year and for each destination county $i$:

$$  mig_{it} = \frac{ \sum_{j\ne i} out_{jit} y_{j,t-1} + y_{i,t-1} (pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} $$

where

$y_{it}$ was defined above\
$out_{ijt}$ represents the number of migrants from a unique origin county $j$ who migrated to a destination county $i$ between year $t-1$ and year $t$.\
$pop_{i, t-1}$ is the population of an unique destination county $i$ at initial year $t-1$\

Model fitting

<!--# make more clear that migration term is added next -->We began with our baseline model and iteratively added splines for the prior year's average county-level premature mortality rate and the migration term to capture potential nonlinear trends. To determine the best fitting model, we analyzed several models using the Bayesian Information Criterion (BIC), which is commonly used to identify models with the greatest explanatory power \[\@kuha2004\]. We observed that keeping the degrees of freedom equal for the splines of both the migration term and the premature mortality rate resulted in lower BIC scores, indicating better model fit. All models accounted for both spatial and random error and were created using the `splm` and `splines` R packages \[\@splines\]\[\@millo2023\].

<!--# this goes in the results section -->The table below presents descriptive statistics for $y_{it}$â€‹ (premature age-adjusted mortality rate) and migration rates, categorized by year and county type. Note that migration rates for the year 2011 are not included. This is because the migration-flow data starts from 2011 to 2012, and these values are shown in the 2012 section of the table, corresponding with the 2012 premature age-adjusted mortality rates.

```{r table1 as dreamed up by chatgpt }

# this should go in the result section!!! 

# probably need to find a way to add units to this somehow 
library(tidyverse)
library(ggplot2)
library(table1)

load("data_processed/migterm_imp.Rdata")

migterm_imp$migrat = as.numeric(migterm_imp$totin_d)/as.numeric(migterm_imp$pop_d0)*1000

migterm_imp = migterm_imp %>% 
   mutate(
    rural = factor(rural, levels = c(0, 1), labels = c("Urban", "Rural"))
  )

# Define labels for the table
table1::label(migterm_imp$destid) = "County"
table1::label(migterm_imp$year) = "Year"
table1::label(migterm_imp$migrat) = "Migration rate"
table1::label(migterm_imp$rate_d1) = "Premature age-adjusted mortality rate"
table1::label(migterm_imp$rural) = "Urban/Rural"

# Define units for the columns
table1::units(migterm_imp$migrat) <- "per 1,000"
table1::units(migterm_imp$rate_d1) <- "per 100,000"

# Filter data for rural
rural_data <- migterm_imp %>% filter(rural == "Rural")

# Filter data for urban
urban_data <- migterm_imp %>% filter(rural == "Urban")

# Generate the table for rural with title
table_rural <- table1::table1(~ migrat + rate_d1 | year, 
                              data = rural_data, 
                              overall = "Total", 
                              title = "Table 1: Rural Counties",
                              caption = "Migration Rate and Mortality Rate stratified by Year for Rural Counties")

# Generate the table for urban with title
table_urban <- table1::table1(~ migrat + rate_d1 | year, 
                              data = urban_data, 
                              overall = "Total", 
                              title = "Table 2: Urban Counties",
                              caption = "Migration Rate and Mortality Rate stratified by Year for Urban Counties")

# Display the tables
table_rural
table_urban

```

Our weighted-average approach implicitly accounts for between-county selection for migration but does not account for within-county selection of migrants. In other words, our best guess for the mortality rate of migrants is exactly the mortality rate of their original county; meanwhile, some counties are more likely to be destinations for migration than others.

To determine whether the role that county-to-county migration flows play in county-level health outcomes differs significantly between rural and urban counties (Hypothesis 2), we added a factor term for urbanicity including interaction terms between urbanicity and $y_{i,t-1}$ and urbanicity and $mig_{i,t}$ to the models accounting for spatial error used to test Hypothesis 1. We again compared these models using BIC while iteratively adding splines with equal degrees of freedom for migration and lagged premature mortality.

To maximize the number of counties per category, we chose to use only two urbanization categorizations: urban and rural, where urban includes large central metro, medium metro, and small metro counties, and rural includes micropolitan and noncore counties. We assessed `r length(unique(migterm_imp$destid[migterm_imp$rural == 1]))` unique rural counties and `r length(unique(migterm_imp$destid[migterm_imp$rural == 0]))` unique urban counties over 8 migration periods. We utilized the same steps outlined above to determine which model had the most explanatory power and lowest BIC score.

Finally, to determine whether taking into account unmeasured factors in county-to-county migration flows improves our ability to explain county-level health outcomes (Hypothesis 3), we added parameters $k_{ij}$ and $l_i$ to the premature mortality rate of each origin $j$ and each destination $i$ within our equation for the migration term. We call this new simulated migration term $smig_{it}$. The equation for $smig_{it}$ is shown below:

$$  smig_{it}(k_{ij}, l_i) = \frac{ \sum_{j\ne i} out_{jit} ( y_{j,t-1} + k_{ij}) + (y_{i,t-1} + l_i) (pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} $$

We use $smig_{it}$ to simulate within-county selection for migration: when the parameter $k_{ij}$ is subtracted (ie decreased mortality rate), we simulate migration by individuals who are healthier than the average of their origin $j$. When the parameter $k_{ij}$ is added (ie increased mortality rate), we simulate migration by individuals who are unhealthier than the average of their origin $j$. Likewise, when the parameter $l_i$ is subtracted (ie decreased mortality rate), we simulate migration by individuals who are healthier than the average of their destination $i$. When the parameter $l_i$ is added (i.e., increased mortality rate), we simulate migration by individuals who are unhealthier than the average of their origin $i$. We specify that $k_{ij}$ depends on both origin $j$ and destination $i$ since health related selection for migration is connected to both the origins and the destinations of counties; meanwhile $l_i$ is dependent only upon the health of destination $i$.

Since we are most interested in how the values of $k_{ij}$ and $l_i$ are related to each other, we chose to simplify $smig_{it}$ such that $l_i$ is held constant and only $k_{ij}$ fluctuates. Therefore, we assign the parameter $d_{ij}$ to be the difference between $k_{ij}$ and $l_i$, thus creating a new equation for $k_{ij}$ in terms of $l_i$ and $d_{ij}$ such that $k_{ij} = l_i+ d_{ij}$. The value of $d_{i,j}$ can be thought of as a modeling term to explain health-related selection bias. <!--# amy's phrasing: "refer to the dij as a modeling term that models health related selection bias" -->Then our equation for $smig_{it}(k_{ij})$ becomes:

$$  smig_{it}(l_i+d_{ij}, l_i) = \frac{ \sum_{j\ne i} out_{jit} ( y_{j,t-1} + l_i + d_{ij}) + (y_{i,t-1} +l_i)( pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} $$

which can be simplified into the following:

$$  smig_{it}(d_{ij}) = \frac{ \sum_{j\ne i} out_{jit} ( y_{j,t-1} + d_{ij}) + y_{i,t-1} (pop_{i, t-1} - \sum_{j\ne i} out_{ijt})}{ \sum_{j\ne i} out_{jit} + (pop_{i,t-1} - \sum_{j\ne i} out_{ijt})} +l_i$$

Therefore, using the equation above, we simulate health-related selection occurring as a result of the differences in health between the origin and the destination counties. When $d_{ij}$ is positive, we estimate that the origin is less healthy than the destination. When $d_{ij}$ is negative, we estimate that the origin is healthier than the destination.

To determine which values of $d_{ij}$ best explain trends in county-level premature mortality rates, we replace $mig_{it}$ with $smig_{it}(d_{ij})$ in the model with the most explanatory power as determined by our previous hypotheses.

We then test potential values of $d_{ij}$ to determine which value produces the lowest BIC score. We incremented by 50 from -200 to 200 such that migrants had an estimated premature mortality rate that was between 200 premature deaths per 100,000 population higher and 200 premature deaths per 100,000 population lower than their origin county.

To understand this phenomenon further, we conducted a grid search to test potential values of $d_{ij}$ when accounting for urbanicity. Specifically, we examined how the values of $d_{ij}$ vary based on the urbanicity of both the origin and destination counties. We defined these variations as follows: $d_{uu}$ for the difference in average health between an urban origin and an urban destination, $d_{rr}$ for the difference in average health between a rural origin and a rural destination, $d_{ru}$ for the difference in average health between a rural origin and an urban destination, and $d_{ur}$ for the difference in average health between an urban origin and a rural destination. In the plot below, we see the number of destination counties for each migration type over time. Notably, the rural-to-rural migration type has the most unique destination counties because there are more rural counties than urban counties. This approach allows us to emphasize all counties, instead of focusing primarily on urban migration, which is more commonly studied.

```{r migtype by year}
load("data_processed/imputed_for_ksim.RData")

#this dataset is called natmorturb_imp
# it has natality, death, population, premature mortality rates, migration flows, rural/urb codes but no migterms (yet)
# it is balanced and has no missing rates (except for initial years)

urbcodes = haven::read_sas("data_raw/nchs_urbanicity_wlabels.sas7bdat") %>% 
  select(fipscode, rural) %>% 
  rename(rural_orig = rural)
#add rural/urb for origin 
nm = natmorturb_imp %>% rename(rural_dest = rural) %>% 
  left_join(urbcodes, by = join_by(origid == fipscode)) %>% 
  mutate(migtype = ifelse(!is.na(rural_dest)& !is.na(rural_orig), paste0(rural_dest, rural_orig), NA)) 


migtypecounts = nm %>% group_by(migtype, year) %>% 
  summarize(n_distinct(destid)) %>% 
 # filter(year !=2011) %>% # these nas are for getting the initial
  filter(!is.na(migtype)) %>% #these nans are just for getting the starting pop and mort vals for each county for each year 
  mutate(year = as.numeric(year))

# Define mapping for migtype labels
migtype_labels <- c("00" = "Urban-to-urban",
                    "11" = "Rural-to-rural",
                    "10" = "Urban-to-rural",
                    "01" = "Rural-to-urban")
my_palette <- c("#1f78b4", "#33a02c", "#e31a1c", "#ff7f00")

ggplot(data= migtypecounts) + 
  geom_point(aes(x = year, y = `n_distinct(destid)`, color = migtype)) + 
  geom_line(aes(x = year, y = `n_distinct(destid)`, color = migtype)) + 
  scale_x_continuous(breaks = unique(migtypecounts$year), labels = function(x) paste0(x - 1, " - ", x)) +
  scale_color_manual(values = my_palette, labels = migtype_labels) +
  labs(x = "Year", y = "Count of unique destination counties", color = "") +
   theme_bw() +
  theme(axis.text.x = element_text(angle = 20, hjust = 1)) 

#urban to urban is basically flat because basically all urban counties are linked by migration 
# there are 1159 unique urban destids in the dataset: nm %>% filter(rural_dest ==0) %>% summarize(n_distinct(destid))
# and 2011-2012 and 2012-2013 appear similar but they do in fact have different values (no error here) 
  
```

We began with a broad increment of 50, testing \$d\_{ij}\$ values ranging from -200 to 200 premature deaths per 100,000 higher than the destination county, resulting in 6,561 unique sets of \$(d\_{uu}, d\_{rr}, d\_{ru}, d\_{ur})\$. After identifying a range of \$d\_{ij}\$ values that minimized the BIC score, we refined our search. Using a smaller increment of 10, we tested \$d\_{ij}\$ values within a range of -40 to 40 premature deaths per 100,000 higher than the destination county, resulting in another 6,561 unique sets of \$(d\_{uu}, d\_{rr}, d\_{ru}, d\_{ur})\$. Finally, observing trends in BIC for models with \$d\_{ij}\$ values between -40 and 40, we noted patterns suggesting the lowest BIC score might result from \$d\_{ru}\$ and \$d\_{ur}\$ values outside this range. Thus, we performed another refined search, holding \$d\_{uu}\$ and \$d\_{rr}\$ constant at 0 and iterating from 0 to 100 by 5 for both \$d\_{ur}\$ and \$d\_{ru}\$, resulting in an additional 441 unique sets of $(d_{uu}, d_{rr}, d_{ru}, d_{ur})$. <!--# flowchart here???? -->

<!--# present all results for transparency -->

<!--# add colors to plots for other varied -->

<!--# appendix: add plots for every possibilities of dij -->

### [**Results and Conclusions**]{.underline}

To justify further investigation, we first determined that our migration term added explainability (as measured by lower BIC scores) to our most basic autoregressive model accounting for spatial error. The best fitting model in terms of BIC score included splines with four degrees of freedom for both the autoregressive term and our weighted average migration term. This indicates that models incorporating migration had more explanatory power than models that included only the prior year's average county-level mortality rate.

Next, we sought to determine whether our migration term would improve the explainability of our spatiotemporal model, even after accounting for urbanicity. We added interaction terms between urbanicity and lagged premature mortality and urbanicity and migration. After adjusting for urbanicity, we found that the models with the lowest BIC scores included splines with four degrees of freedom each for the migration term and lagged age-adjusted mortality. This further confirmed that the migration term added explainability to our models, even when accounting for urbanicity.

The plot below demonstrates lower BIC scores for models that include the migration term along with an interaction between $y_{it}$ and urbanicity. The difference in BIC scores between models that include the migration term and those that do not is more pronounced when an interaction term for urbanicity is added. This suggests that the migration term significantly enhances model explainability when accounting for urbanicity, indicating that the relationship between average county-level health and migration may differ substantially across urbanicity levels.

```{r spatial models only, echo = FALSE, warning = FALSE, message = FALSE}

spatonly = read.delim("chtc_outputs/modselection_nat.txt", sep = ",")  
ref = spatonly$BIC[spatonly$Model == "fnom"] 

spatonly$refbic = round(spatonly$BIC - ref, 2)   



tf <- spatonly %>%
  mutate(
    `Migration Included` = !grepl("_nomig|nom", Model),
    `Degrees of Freedom` = str_extract_all(Model, "\\d+"),
    `BIC score relative to reference` = refbic,
    `Urbanicity interaction` = grepl("r", Model)
  )
# Convert the list of numbers to a single string or set to "1" if no number is found
tf$`Degrees of Freedom` <- sapply(tf$`Degrees of Freedom`, function(x) {
  if (length(x) == 0) {
    return("1")
  } else {
    return(paste(x, collapse = " "))
  }
})

tf = tf %>% select(`Migration Included`, `Degrees of Freedom`, `BIC score relative to reference`, `Urbanicity interaction`)


tf$`BIC score relative to reference`[tf$`BIC score relative to reference` == 0] = "REF"


tf = tf %>% arrange(`Degrees of Freedom`, `Migration Included`, `Urbanicity interaction`)

ggplot(data = tf, aes(x = `Degrees of Freedom`, 
                      y = as.numeric(`BIC score relative to reference`), 
                      color = `Migration Included`,
                      size = `Urbanicity interaction`,
                      label = ifelse(`BIC score relative to reference` == "REF", "REF", ""))) +    
    geom_point(alpha = 0.6) +  # Include alpha within geom_point
    geom_text(color = "black", size = 5, fontface = "bold", 
              nudge_y = 0.05, check_overlap = TRUE) +  # Add text labels with adjustments
    theme_bw() +
    labs(x = "DF", y = "BIC relative to reference",
         color = "", size = ""
    ) +
    scale_color_manual(
        values = c("TRUE" = "darkblue", "FALSE" = "darkred"),
        labels = c("TRUE" = "Including migration term", "FALSE" = "Excluding migration term"),
        guide = guide_legend(title = NULL)
    ) +
    scale_size_manual(
        values = c("TRUE" = 5, "FALSE" = 2),
        labels = c("TRUE" = "Including urbanicity interaction", "FALSE" = "Excluding urbanicity interaction"),
        guide = guide_legend(title = NULL)
    ) +
    guides(
        color = guide_legend(order = 1), 
        shape = guide_legend(order = 2), 
        size = guide_legend(order = 2),
        alpha = "none"
    ) +
    coord_cartesian(ylim = c(min(as.numeric(tf$`BIC score relative to reference`), na.rm = TRUE) * 1.1, 0)) 

```

<!--# this goes in the model fitting section; no equations in results; and no data in method!! table1 is first thign in results -->In the plot above, we see that there is very little difference in the BIC scores of models with splines with two degrees of freedom and models with splines with four degrees of freedom. Due to concerns about potential overfitting, and since there appears to be little to no explainability added by additional degrees of freedom, we choose to use a model with splines with two degrees of freedom for lagged premature mortality rate and migration term. Thus, the model we use in our simulation is as follows:

$$  y_{it} = \beta_0 + \sum_{k=1}^{K} \beta_{1k} \cdot \text{ft}_{k} + \sum_{k=1}^{K} \beta_{2k} ns(y_{t-1,i}, 2) \cdot r_i^{k} + \sum_{k=1}^{K} \beta_{3k} ns(migterm_{it}, 2) \cdot r_i^{k} + \sum_{k=1}^{K} \beta_{4k} r_i^{k} + \mu_i + \epsilon_{it} + \lambda W \epsilon_{it} + u_{it} $$

where (in addition to the terms defined in our baseline model)

$r_i$ is a binary indicator variable equal to 1 for rural destination counties $i$ and 0 for urban destination counties $i$\
$ns(y_{t-1,i}, 2)$ is a natural spline transformation of the lagged premature age-adjusted mortality rate with 2 degrees of freedom\
$ns(migterm_{it}, 2)$ is a natural spline transformation of the migration term with 2 degrees of freedom\

The model above is the model we used in each of our simulations of health-related selection for migration, but we replaced \$mig\_{it}\$ with $smig_{it}(d_{ij})$, as defined above, where \$d\_{ij}\$ is a modeling term used to measure the difference between the average health of an origin county and the average health of a destination county. We found that the model with the most explanatory power had $d_{ij} = 0$ . As the magnitude of the difference between the health of origin and destination increased, our models had less explanatory power and higher BIC scores. This is shown in the plot below.

```{r ksim without urb, just k, echo = FALSE}
#this might have to be removed or updated since it uses 4df 

load("data_processed/bick_nourb_tot.Rdata")

ggplot(data = bick_nourb_tot, aes(x = as.numeric(newk), y = as.numeric(bicspat))) +
  geom_point() +
  theme_bw() + 
  labs(x = expression(d[ij]), 
       y = "BIC score")
```

In a secondary simulation, in which we varied \$d\_{ij}\$ for each possible combination of origin and destination type and incremented by 50, we did not find any evidence of health-related selection for migration. But when we narrowed our increment to 10 and used a more precise range, we found some evidence of health-related selection for migration to rural destinations from urban origins and to urban destinations with rural origins but not for migration between counties with the same urbanicity type (rural to rural and urban to urban). In the plot below, we see that the minimum BIC score occurs for $(d_{uu} =0, d_{rr}=0, d_{ru}=25, d_{ur} = 40)$. This suggests that for rural to urban migration, represented by $d_{ur}$, rural origins have slightly higher premature age-adjusted mortality rates than their corresponding urban destinations. Meanwhile, for urban to rural migration, represented by $d_{ru}$, urban origins have slightly higher premature age-adjusted mortality rates than their corresponding rural destinations. In both cases, movers tend to migrate from less healthy places to healthier places, with the difference between the average health of the origin and the average health of the destination being slightly greater when moving from rural to urban. Of course, this makes sense, since, on average, rural counties have higher premature age-adjusted mortality rates than urban counties.

In the plot below, we see $d_{ur}$ and $d_{ru}$ plotted versus BIC score while holding $d$ for all other migration types constant at 0. The trend in BIC score is primarily driven by $d_{ru}$, suggesting that migration from urban origins to rural destinations primarily drives the explanatory power of models of county-level health. This makes sense because there are more rural destination counties than urban destination counties. Additionally, rural counties have smaller populations than urban counties which makes their average health more malleable.

```{r separate plots for kur and kru mins }

# can describe holding vars constant as examining the trends while no selection bias in some regions; for interpretability, etc 
# of the four params, which ones are most important (prob non zeros)

library(ggplot2)
library(dplyr)

load("data_processed/bick_restrict.Rdata")
# Combine the datasets and convert columns to numeric
bicktot <- bick_restrict %>%
  mutate(
    kur = as.numeric(kur),
    krr = as.numeric(krr),
    kuu = as.numeric(kuu),
    kru = as.numeric(kru)
  )

# Find the most explanatory set
mostex <- bicktot %>% filter(bicspat == min(bicspat))

# Create a combined dataset for plotting
bicmin_kuu <- bicktot %>% filter(kru == 0 & krr == 0 & kur == 0)
bicmin_kur <- bicktot %>% filter(kru == 0 & kuu == 0 & krr == 0)


# Plot
ggplot(bicmin_kuu, aes(x = kuu, y = as.numeric(bicspat))) +
  geom_point() +
  xlab(expression(d[ij])) +
  ylab("BIC") +
  theme_bw() +
  labs(subtitle = expression(paste("Relationship between BIC and ", d[ru], "\n (assuming that ", d[ru], " = 0, ", d[uu], " = 0, and ", d[ur], " = 0)")),
       title = "Urban-to-Rural Migration") +
  guides(color = guide_legend(title = NULL))

# Plot
ggplot(bicmin_kur, aes(x = kur, y = as.numeric(bicspat))) +
  geom_point() +
  xlab(expression(d[ur])) +
  ylab("BIC") +
  theme_bw() +
  labs(subtitle = expression(paste("Relationship between BIC and ", d[ur], "\n (assuming that ", d[rr], " = 0, ", d[uu], " = 0, and ", d[ru], " = 0)")),
       title = "Rural-to-Urban Migration") +
  guides(color = guide_legend(title = NULL))


```

```{r plot that has mins for both kur and kru on a single xy}
library(ggplot2)
library(dplyr)

load("data_processed/bick_restrict_tot.Rdata")
load("data_processed/bickdf.Rdata")
# Combine the datasets and convert columns to numeric
bicktot <- rbind(bick_restrict_tot, bickdf) %>%
  mutate(
    kur = as.numeric(kur),
    krr = as.numeric(krr),
    kuu = as.numeric(kuu),
    kru = as.numeric(kru)
  )

# Find the most explanatory set
mostex <- bicktot %>% filter(bicspat == min(bicspat))

# Create a combined dataset for plotting
bicmin_kru <- bicktot %>% filter(kuu == mostex$kuu & krr == mostex$krr & kur == 0)
bicmin_kur <- bicktot %>% filter(kru == 0 & kuu == mostex$kuu & krr == mostex$krr)

# Add a column to distinguish between kur and kru
bicmin_kru <- bicmin_kru %>% mutate(type = "kru")
bicmin_kur <- bicmin_kur %>% mutate(type = "kur")

# Combine the datasets for plotting
bicmin_combined <- bind_rows(bicmin_kru, bicmin_kur)

# Plot
ggplot(bicmin_combined, aes(x = as.numeric(ifelse(type == "kru", kru, kur)), y = as.numeric(bicspat), color = type)) +
  geom_point() +
  xlab(expression(d[ij])) +
  ylab("BIC") +
  theme_bw() +
  labs(subtitle = expression(paste("Relationship between BIC and ", d[ij], "\n (assuming that ", d[rr], " = 0, and ", d[uu], " = 0)")),
       title = "Urban-Rural Migration") +
  scale_color_manual(values = c("kru" = "blue", "kur" = "red"), labels = c("kru" = expression(paste(d[ru], " when ", d[ur], " is held constant at 40")), "kur" = expression(paste(d[ur], " when ", d[ru], " is held constant at 25")))) +
  guides(color = guide_legend(title = NULL))

```

This finding supports the idea that migration is often aspirational. Migrants are more likely to move from less healthy areas to more healthy areas. Additionally, we have shown that migrants may be healthier on average than the places they are leaving, which matches the current understanding that migrants are healthier on average than the general population. <!--# cite --> Interestingly, rural to rural migrants and urban to urban migrants appear to have similar health on average as their origins and destinations. Perhaps the reasons for moving from a rural county to another rural county are less likely to be related to health than the reasons for moving from a rural county to an urban county. Likewise, moving from one city to another is seemingly less health related than moving from a city to a rural area. Interestingly, when we isolate the effects of rural-urban migration and urban-rural migration on BIC score separately, we see that trends in BIC score are primarily driven by urban-to-rural migration, even though the difference in health of an urban origin and rural destination is slightly smaller than for rural origins and urban destinations. This could be drive by the fact that there are more rural counties than urban counties and rural counties are less healthy on average than urban counties. It might be interesting to study a subset of origin-destination pairs for which rural origins have better health than urban destinations to better understand alternative possibilities.

### Discussion and Limitations {.underline}

We consider several pitfalls and alternatives. First, because our migration term is essentially a weighted average of the mortality rates of origin counties, the migration term and lagged mortality rates are highly correlated, resulting in multicollinearity. As a result, we cannot easily interpret the effect of the migration term itself, other than knowing that its inclusion results in a model with more explanatory power over all. Application of results must consider this shortcoming.

Second, we selected our outcome of interest, county-level premature age-adjusted mortality, because it is comparable across years and locations and because it is consistently and robustly defined. However, in 2019, the median age of all movers across the US was under 30 years old [@s0701:g] - therefore, even when accounting for premature mortality (deaths occurring in individuals under age 75), the population that is migrating is not necessarily the same population that is dying. Subsequently, trends in county-level premature mortality might be better explained by trends in county-level migration twenty to fifty years earlier. That said, county-level measures of premature mortality are commonly used as a proxy for county overall health. For instance, a 1983 report by the WHO recommending measures in mortality and morbidity to understand the relationship between health and migration [@gushulak2006], and measures of length of life are allocated 50% weight in the County Health Rankings Model of place-based health outcomes [@explore]. Ideally we would use a more precise age-group-specific measure of mortality paired with an age-group-specific measure of migration; however, this would require a migration data source other than the IRS migration flow data which we use here and therefore could not include analysis of the entire United States. Additionally, ideally, we would confirm our findings by assessing the health of migrants themselves. This task would require individual longitudinal data. This is not currently within the scope of this project.

One final limitation of IRS data (which we are attempting to leverage as a strength in our analyses) is that households that do not file tax returns cannot be included in migration estimates. Therefore, many university students, low-income households, and workers who receive informal wages are systematically missing from IRS migration estimates[@dewaard2022]. These individuals may be more likely to be included in ACS and Census estimates [@bureau] though no population estimate is perfect. Because IRS county-to-county migration data includes only individuals who file taxes with the US government both before and after they migrate, we assume that individuals represented in the IRS migration flows data are less likely to be pushed to migrate by potentially health-related factors such as violence, famine, and corruption than individuals who migrate but are excluded from the IRS data. Therefore, any differences in changes in health between counties may be the result of self-selection by IRS-represented migrants or health-related selection by nonIRS-represented migrants. Despite these limitations, IRS migration data has been used many times in the past to complete complex and accurate analyses of US migration patterns. For instance, IRS migration flow data has been used to estimate the effects of sea-level rise on geographic distribution of the US population[@hauer2017], measure recovery after Hurricanes Katrina and Rita[@curtis2015], and assess the economic impacts of migration resulting from environmental hazards [@shumway2014].

<!--# paragraph in discussion section about policy lens; NOTE: all data is pre covid -->

Additionally, since we rely on IRS migration flow data from 2011 through 2019, all data are pre-COVID. The COVID pandemic caused XXX migration during the time period and may have also influenced some individuals to migrate from rural to urban and from urban to rural locations more than others. CITE. <!--# policy lens -->

There are many factors that contribute to the health of a place. In our analyses, we have chosen to emphasize the potential impact of migration or movement between places on place-based health. We accounted for intercounty selection for migration (ie some counties are more likely to experience migration than others) using our weighted average migration term and intracounty selection for migration (ie some individuals are more likely to migrate than others) using our \$d\_{ij}\$ simulation. We cannot fully understand county-level health without first understanding county interconnectedness and how it drives place-based health disparities. Recognizing that the United States is heterogeneous and that the mechanisms by which migration may impact health may also be heterogeneous, we attempt to quantify rural-urban differences in the relationship between migration and place-based health. The long-term goal of this work is to contribute to understanding the mechanisms by which mobility may be related to place-based health disparities so that local decision-makers may account for patterns in mobility when creating policy towards improved health for all people in all places. Understanding rural-urban mobility patterns is a necessary first step towards understanding rural-urban health disparities.
